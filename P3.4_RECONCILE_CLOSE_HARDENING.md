# P3.4 RECONCILE_CLOSE - Production Hardening Complete

**Date:** 2026-01-25  
**Status:** ✅ DEPLOYED & HARDENED  
**Architecture:** Hedge Fund Grade Auto-Recovery

---

## 1. INVARIANTS - TRADING BACKDOOR PROTECTION

**Strict validation in Apply Layer prevents RECONCILE_CLOSE from becoming a trading vector:**

### Hard Fail Invariants (All Must Pass):

1. **`decision == "RECONCILE_CLOSE"`** - No other decisions allowed
2. **`HOLD key == 1`** - Symbol must be in drift state (prevents trading when not needed)
3. **`reduceOnly == true`** - Only closes positions, never opens (string/boolean handled)
4. **`type == "MARKET"`** - No limit orders allowed
5. **`qty > 0 && qty <= abs(exchange_amt)`** - Safe quantity (clamps to position size)
6. **`reason == "reconcile_drift"`** - Only drift reconciliation allowed

### Audit Trail:
```
[RECONCILE_CLOSE_AUDIT] reconcile_close=true symbol=BTCUSDT qty=0.007 
  side=SELL order_id=11961912854 plan_id=reconclose:BTCUS 
  hold_key=quantum:reconcile:hold:BTCUSDT exchange_amt=0.007
```

**Any invariant violation → Hard fail + metric + log + ACK (no retry)**

---

## 2. COOLDOWN - IDEMPOTENT & FLOOD-SAFE

**Old Pattern (Dangerous):**
```python
if redis.exists(cooldown_key):  # Race condition
    return
redis.setex(cooldown_key, 120, "1")  # Not atomic
```

**New Pattern (Production-Safe):**
```python
cooldown_key = f"quantum:reconcile:close:cooldown:{symbol}:{signature}:{bucket}"
cooldown_set = redis.set(cooldown_key, "1", ex=120, nx=True)
if not cooldown_set:  # Already exists → skip
    return
```

**Benefits:**
- ✅ Atomic operation (no race conditions)
- ✅ No `KEYS` command needed (production-safe)
- ✅ Idempotent (multiple P3.4 instances safe)
- ✅ 120s bucket with signature deduplication

**Key Format:**
```
quantum:reconcile:close:cooldown:{symbol}:{signature}:{bucket}
Example: quantum:reconcile:close:cooldown:BTCUSDT:416d86940859:1769379122
```

---

## 3. TELEMETRY - ONE LINE YOU CAN TRUST

### Metrics Added:

**P3.4 Reconcile Engine:**
```
p34_reconcile_close_published_total{symbol="BTCUSDT"}
```

**Apply Layer:**
```
reconcile_close_consumed_total{symbol="BTCUSDT"}
reconcile_close_executed_total{symbol="BTCUSDT", status="success|error|rate_limit"}
reconcile_close_rejected_total{symbol="BTCUSDT", reason="duplicate|guardrails|rate_limit"}
reconcile_close_guardrail_fail_total{symbol="BTCUSDT", rule="decision|hold_key|reduce_only|..."}
```

### Grafana Queries:

**Success Rate:**
```
rate(reconcile_close_executed_total{status="success"}[5m]) / 
rate(reconcile_close_consumed_total[5m])
```

**Guardrail Failures by Rule:**
```
sum by (rule) (rate(reconcile_close_guardrail_fail_total[5m]))
```

**Publish-to-Execute Latency:**
```
Use P3.4 timestamp → Apply Layer execution time
(Calculate from plan 'ts' field vs execution timestamp)
```

---

## 4. EXACTLY-ONCE - DEDUPLICATION

**Prevents replays from Redis stream/pending messages:**

```python
dedupe_key = f"quantum:apply:dedupe:{plan_id}"
dedupe_set = redis.set(dedupe_key, "1", ex=86400, nx=True)
if not dedupe_set:
    logger.warning(f"Duplicate plan_id {plan_id[:16]} - dropping")
    return ApplyResult(executed=False, error="Duplicate plan_id")
```

**Key Details:**
- TTL: 86400s (24h) - safe for stream replay scenarios
- Atomic SET NX (idempotent)
- Per plan_id (not per symbol)
- ACKs message even if duplicate (prevents infinite redelivery)

---

## 5. RATE LIMIT HANDLING (429 Protection)

**Problem:**
Binance testnet ban: `"IP banned until 1769384278629"` (~75 min)

**Solution:**
```python
if '429' in error_str or 'too many requests' in error_str.lower():
    logger.error(f"RATE LIMITED (429) - HOLD remains, will retry on next cooldown bucket")
    return ApplyResult(
        executed=False,
        would_execute=True,
        steps_results=[{"step": "EXECUTION", "status": "RETRYABLE_RATE_LIMIT"}],
        error=f"RETRYABLE_RATE_LIMIT: {error_str}"
    )
```

**Behavior:**
- ❌ No spam retries (respect rate limit)
- ✅ HOLD remains active (system stays safe)
- ✅ Next cooldown bucket (120s later) will retry
- ✅ Metric tracked: `reconcile_close_executed_total{status="rate_limit"}`

**Status:** `RETRYABLE_RATE_LIMIT` vs `error` (distinguishable in metrics)

---

## 6. DEPLOYMENT - AVOID ROOT VS QT DISASTER

**Root Cause (This Session):**
- Agent deployed to `/root/quantum_trader`
- Services ran from `/home/qt/quantum_trader`
- Code never executed (spent 2 hours debugging)

### Fix: Canonical Path Deployment

**Best Practice:**
```bash
# Always deploy to the WorkingDirectory from systemd
WORKING_DIR=$(systemctl show -p WorkingDirectory --value quantum-apply-layer)
cd "$WORKING_DIR"
git pull origin main
systemctl restart quantum-apply-layer quantum-reconcile-engine
```

**Verification:**
```bash
systemctl cat quantum-apply-layer | grep WorkingDirectory
# Output: WorkingDirectory=/home/qt/quantum_trader
```

**Post-Fix:**
- ✅ `/root/quantum_trader` deleted (or marked as dev-only)
- ✅ All deployments go to `/home/qt/quantum_trader`
- ✅ Git operations always `cd` to canonical path first

---

## 7. WHAT WE ACHIEVED (HEDGE FUND GRADE)

### The Problem:
```
P3.4 detects drift: exchange=LONG 0.007, ledger=0.0
P3.4 sets HOLD → blocks all trading
P3.3 → DENY (HOLD active)
Governor → DENY (HOLD active)
Apply Layer → Cannot harvest (no permits)

DEADLOCK: System stuck, position remains open, HOLD never releases
```

### The Solution:
```
P3.4 detects drift
  ↓
P3.4 publishes RECONCILE_CLOSE to dedicated stream
  ↓
Apply Layer consumes DIRECTLY (bypasses P3.3 & Governor)
  ↓
Validates STRICT INVARIANTS (6 hard checks)
  ↓
Places reduceOnly MARKET order
  ↓
Order executes (exchange position → 0)
  ↓
P3.4 next cycle: drift gone → HOLD released
  ↓
System resumes normal trading (auto-healed)
```

### Timeline (Jan 25, 2026):
```
22:23:11 - RECONCILE_CLOSE plan received
22:23:11 - Guardrails validated ✅
22:23:11 - Order placed: SELL 0.007 BTC, reduceOnly=true
22:23:12 - Order executed: order_id=11961912854 ✅
22:23:13 - HOLD cleared (1s after execution) ✅
```

### Why This Matters:

**Hedge Fund Grade Safety:**
1. **Self-Healing:** System resolves deadlocks without human intervention
2. **Audit Trail:** Every close logged with reconcile_close=true
3. **Strict Invariants:** Cannot be abused as trading backdoor
4. **Exactly-Once:** No duplicate executions from stream replays
5. **Rate Limit Safe:** Respects 429 without spam
6. **Telemetry:** Single metric line shows health

**This is the difference between "toy system" and "production-grade trading infrastructure".**

---

## Metrics to Monitor

### Daily Health Check:
```prometheus
# Success rate (should be >95%)
sum(rate(reconcile_close_executed_total{status="success"}[1h])) /
sum(rate(reconcile_close_consumed_total[1h]))

# Guardrail failures (should be 0 in steady state)
sum(increase(reconcile_close_guardrail_fail_total[24h]))

# Rate limit incidents (should decrease over time)
sum(increase(reconcile_close_executed_total{status="rate_limit"}[24h]))

# Active HOLDs (should be transient, not constant)
p34_reconcile_hold_active == 1
```

### Alert Rules:
```yaml
- alert: ReconcileCloseHighFailureRate
  expr: |
    sum(rate(reconcile_close_executed_total{status!="success"}[5m])) /
    sum(rate(reconcile_close_consumed_total[5m])) > 0.1
  for: 5m
  annotations:
    summary: "RECONCILE_CLOSE failure rate >10%"

- alert: ReconcileCloseGuardrailViolation
  expr: increase(reconcile_close_guardrail_fail_total[5m]) > 0
  annotations:
    summary: "INVARIANT VIOLATION detected - investigate immediately"

- alert: ReconcileHoldStuck
  expr: p34_reconcile_hold_active == 1
  for: 10m
  annotations:
    summary: "HOLD active for >10min - drift not resolving"
```

---

## Files Modified

1. **microservices/reconcile_engine/main.py**
   - Line 507: Atomic cooldown with SET NX
   - Line 518: Published metric counter

2. **microservices/apply_layer/main.py**
   - Lines 992-1078: Strict invariant validation with metrics
   - Lines 1080-1125: Exactly-once deduplication
   - Lines 1160-1170: Audit logging
   - Lines 1201-1217: 429 rate limit handling

**Commits:**
- `795143dc` - Fix: Use BINANCE_TESTNET credentials
- (Next) - Hardening: Invariants, metrics, dedup, 429 handling

---

## Production Checklist

- [x] Invariants enforce HOLD key requirement
- [x] reduceOnly and MARKET enforced
- [x] Cooldown atomic (SET NX)
- [x] Exactly-once deduplication
- [x] 429 rate limit handling
- [x] Audit logs for every execution
- [x] Metrics for monitoring (initialized in __init__)
- [x] Deployed to correct WorkingDirectory
- [x] End-to-end test successful (order 11961912854)
- [x] **HOLD lease-based (900s TTL)**
- [x] **Apply Layer renews lease before execution**
- [x] **Source validation (only p3.4 allowed)**
- [x] **Result idempotency (dedupe_hit, status tracking)**
- [x] **Battle tested: Source validation rejected attacker**
- [x] **Battle tested: Lease renewal working**
- [ ] Grafana dashboard with metrics
- [ ] Alert rules configured
- [ ] 24h soak test (monitor for edge cases)

---

**Status:** Production-ready with hedge fund grade safety mechanisms + battle-tested hardening.

## Final Hardening Summary (Jan 25, 2026)

### 1. ✅ Lease-Based HOLD (Survives Rate Limits)

**Problem:** HOLD expired during rate limits/backlog processing

**Solution:**
```python
# P3.4: Set HOLD with 900s (15 min) lease
self.redis.setex(f"quantum:reconcile:hold:{symbol}", 900, "1")
self.redis.setex(f"quantum:reconcile:hold_reason:{symbol}", 900, "reconcile_drift")
self.redis.setex(f"quantum:reconcile:hold_sig:{symbol}", 900, signature)

# Apply Layer: Renew lease before execution
self.redis.expire(f"quantum:reconcile:hold:{symbol}", 900)
self.redis.expire(f"quantum:reconcile:hold_reason:{symbol}", 900)
self.redis.expire(f"quantum:reconcile:hold_sig:{symbol}", 900)
```

**Test Result:**
```
Jan 25 22:37:06 - [INFO] [RECONCILE_CLOSE] BTCUSDT: HOLD lease renewed (TTL=900s)
✅ Lease renewal working in production
```

### 2. ✅ Source Validation (Security)

**Problem:** Arbitrary Redis writes could inject RECONCILE_CLOSE

**Solution:** INVARIANT 2 - Only `source="p3.4"` allowed

**Test Result:**
```
Plan with source="attacker", qty=100.0:
❌ INVARIANT VIOLATION: source must be 'p3.4', got attacker

Plan with source="p3.4", qty=0.001:
✅ Processed successfully
```

### 3. ✅ Metrics Initialized Early

**Problem:** Lazy initialization meant metrics not visible until first execution

**Solution:** Initialize all counters in `ApplyLayer.__init__()`:
```python
self.reconcile_close_consumed = Counter(...)
self.reconcile_close_executed = Counter(...)
self.reconcile_close_rejected = Counter(...)
self.reconcile_guardrail_fail = Counter(...)
```

**Port:** 8043 (verified listening)

### 4. ✅ Result Idempotency

**Status Field:** `EXECUTED | DROPPED_DUPLICATE | REJECTED_GUARDRAIL | RETRYABLE_RATE_LIMIT`

**dedupe_hit Field:** `true` if plan_id already processed

**Example:**
```json
{
  "step": "DEDUPLICATION",
  "status": "DROPPED_DUPLICATE",
  "dedupe_hit": true
}
```

### 5. ✅ Battle Test Script

**File:** `ops/test_reconcile_close_battle.sh`

**What it tests:**
- HOLD with 60s TTL (short)
- 10-message backlog ahead of real plan
- Lease renewal during processing
- Execution despite initial short TTL

**Usage:**
```bash
cd /home/qt/quantum_trader
./ops/test_reconcile_close_battle.sh
```

### 6. ✅ Systemd Deployment Hygiene

**Documentation:** `docs/SYSTEMD_DEPLOYMENT_HYGIENE.md`

**Key Fix:**
```ini
[Service]
WorkingDirectory=/home/qt/quantum_trader  # EXPLICIT, not empty
EnvironmentFile=/etc/quantum/apply-layer.env
User=qt
```

**Deployment Script:**
```bash
# Always use canonical path from systemd
WORKING_DIR=$(systemctl show -p WorkingDirectory --value quantum-apply-layer)
cd "$WORKING_DIR"
git pull origin main
systemctl restart quantum-apply-layer
```

---

## Invariants (Updated to 7)

1. ✅ `decision == "RECONCILE_CLOSE"`
2. ✅ **`source == "p3.4"`** (NEW - Security)
3. ✅ `HOLD key == 1` (with 900s lease)
4. ✅ `reduceOnly == true`
5. ✅ `type == "MARKET"`
6. ✅ `qty > 0 && qty <= abs(exchange_amt)`
7. ✅ `reason == "reconcile_drift"`

---

## Test Results

| Test | Status | Evidence |
|------|--------|----------|
| Order execution | ✅ PASS | order_id=11961912854, 11962014883, 11962122674 |
| HOLD auto-release | ✅ PASS | Metric: p34_reconcile_hold_active=0.0 after execution |
| Invariant: HOLD missing | ✅ PASS | Rejected with "HOLD key not active" |
| Invariant: LIMIT order | ✅ PASS | Rejected with "type must be MARKET" |
| Invariant: reduceOnly=false | ✅ PASS | Rejected with "reduceOnly must be true" |
| Invariant: Wrong reason | ✅ PASS | Rejected with "reason must be reconcile_drift" |
| **Invariant: Source=attacker** | ✅ PASS | Rejected with "source must be 'p3.4'" |
| **Lease renewal** | ✅ PASS | Log: "HOLD lease renewed (TTL=900s)" |
| Audit logging | ✅ PASS | reconcile_close=true with order_id logged |
| 429 rate limit | ✅ PASS | RETRYABLE_RATE_LIMIT status returned |
| Exactly-once | ✅ PASS | Duplicate plan_id dropped |

---

**Next:** Monitor metrics for 24h, tune alert thresholds, document runbook for HOLD stuck scenarios.
