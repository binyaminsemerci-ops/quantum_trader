# Prometheus Alert Rules - Quantum Harvest Observability (P2.7C)
# File: /etc/prometheus/rules/quantum_harvest_alerts.yml
# Purpose: Monitor harvest proposal metrics and exporter health
# Reload: systemctl reload prometheus

groups:
  - name: quantum_harvest_alerts
    interval: 10s
    rules:

      # A) KillScore high (per symbol)
      # Fires when kill_score >= 0.6 for 2 minutes
      # Indicates edge collapse conditions requiring operator attention
      - alert: QuantumHarvestKillScoreHigh
        expr: quantum_harvest_kill_score >= 0.6
        for: 2m
        labels:
          severity: warning
          component: quantum-trader
          subsystem: harvest
        annotations:
          summary: "Harvest KillScore high for {{ $labels.symbol }}"
          description: "kill_score={{ $value }} >= 0.6 for 2m. Check k_components (regime_flip/ts_drop/sigma_spike/age_penalty) and marketstate inputs."
          runbook: "Grafana: Quantum Harvest Control (P2.7) → Kill Score + Components panels"

      # B) KillScore critical (escalation)
      # Fires when kill_score >= 0.8 for 1 minute
      # Critical threshold requiring immediate review before P3 apply
      - alert: QuantumHarvestKillScoreCritical
        expr: quantum_harvest_kill_score >= 0.8
        for: 1m
        labels:
          severity: critical
          component: quantum-trader
          subsystem: harvest
        annotations:
          summary: "Harvest KillScore CRITICAL for {{ $labels.symbol }}"
          description: "kill_score={{ $value }} >= 0.8 for 1m. Consider forcing FULL_CLOSE proposal review before P3 apply."
          runbook: "Grafana: Quantum Harvest Control (P2.7) → Actions table + Components"

      # C) Metrics staleness detection
      # Fires when exporter hasn't updated metrics for >30 seconds (sustained 2 minutes)
      # Uses time() (Prometheus server time) vs exporter-provided last_update_epoch
      - alert: QuantumHarvestMetricsStale
        expr: (time() - quantum_harvest_last_update_epoch) > 30
        for: 2m
        labels:
          severity: warning
          component: quantum-trader
          subsystem: harvest
        annotations:
          summary: "Harvest metrics stale for {{ $labels.symbol }}"
          description: "No fresh updates for >30s (for 2m). Check harvest proposal publisher + exporter logs and Redis keys."
          runbook: "Check: systemctl status quantum-harvest-proposal && systemctl status quantum-harvest-metrics-exporter"

      # D) Exporter service down
      # Fires when Prometheus cannot scrape the harvest exporter
      # Critical alert as all harvest monitoring depends on this service
      - alert: QuantumHarvestExporterDown
        expr: up{job="quantum-harvest-exporter"} == 0
        for: 1m
        labels:
          severity: critical
          component: quantum-trader
          subsystem: harvest
        annotations:
          summary: "Harvest metrics exporter DOWN"
          description: "Prometheus scrape failing for job=quantum-harvest-exporter. Check service quantum-harvest-metrics-exporter and firewall/port 8042."
          runbook: "systemctl status quantum-harvest-metrics-exporter; curl -s http://127.0.0.1:8042/health"
