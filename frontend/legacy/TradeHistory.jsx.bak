import React, { useState, useEffect } from 'react';
import axios from 'axios';
import moment from 'moment';
import { Table, Badge, Button, Spinner } from 'react-bootstrap';

const TradeHistory = () => {
  const [trades, setTrades] = useState([]);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState(null);
  const [deleteInProgress, setDeleteInProgress] = useState(null);

  useEffect(() => {
    fetchTrades();
  }, []);

  const fetchTrades = async () => {
    setLoading(true);
    try {
      const response = await axios.get('http://localhost:8000/trades');
      setTrades(response.data);
      setLoading(false);
    } catch (error) {
      console.error('Error fetching trades:', error);
      setError('Failed to load trade history. Please try again later.');
      setLoading(false);
    }
  };

  const handleDelete = async (tradeId) => {
    if (!window.confirm(`Delete trade ${tradeId}?`)) return;
    
    setDeleteInProgress(tradeId);
    try {
      await axios.delete(`http://localhost:8000/trade/${tradeId}`);
      // Update the trades list after deletion
      setTrades(trades.filter(trade => trade.trade_id !== tradeId));
    } catch (error) {
      console.error('Error deleting trade:', error);
      alert('Failed to delete trade. Please try again.');
    } finally {
      setDeleteInProgress(null);
    }
  };

  if (loading) return <div className="trade-history loading">Loading trade history...</div>;
  if (error) return <div className="trade-history error">{error}</div>;

  return (
    <div className="trade-history">
      <h3>Trade History</h3>
      {trades.length === 0 ? (
        <p>No trades found. Create your first trade!</p>
      ) : (
        <Table striped bordered hover responsive>
          <thead>
            <tr>
              <th>ID</th>
              <th>Symbol</th>
              <th>Side</th>
              <th>Quantity</th>
              <th>Price</th>
              <th>Timestamp</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            {trades.map(trade => (
              <tr key={trade.trade_id}>
                <td>{trade.trade_id}</td>
                <td>{trade.symbol}</td>
                <td>
                  <Badge bg={trade.side === 'BUY' ? 'success' : 'danger'}>
                    {trade.side}
                  </Badge>
                </td>
                <td>{trade.quantity}</td>
                <td>{trade.price || 'Market'}</td>
                <td>{moment(trade.timestamp).format('DD.MM.YYYY, HH:mm:ss')}</td>
                <td>
                  <Button 
                    variant="outline-danger" 
                    size="sm"
                    disabled={deleteInProgress === trade.trade_id}
                    onClick={() => handleDelete(trade.trade_id)}
                  >
                    {deleteInProgress === trade.trade_id ? (
                      <><Spinner size="sm" animation="border" /> Deleting...</>
                    ) : (
                      'Delete'
                    )}
                  </Button>
                </td>
              </tr>
            ))}
          </tbody>
        </Table>
      )}
      <Button variant="primary" onClick={fetchTrades}>Refresh</Button>
    </div>
  );
};

export default TradeHistory;
