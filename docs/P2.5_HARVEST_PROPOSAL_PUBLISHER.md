# P2.5 Harvest Proposal Publisher

**Status**: Implementation complete, awaiting VPS deployment and proof pack  
**Phase**: P2.5 (Harvest Proposal Publisher)  
**Type**: Systemd service (calc-only, NO trading)  
**Created**: 2026-01-23

---

## Overview

P2.5 Harvest Proposal Publisher is a systemd service that:
1. Reads **MarketState** from Redis (P0.5 output)
2. Reads **Risk Proposals** from Redis (P1.5 output - provides stop_dist_pct)
3. Reads **Position snapshots** (auto-detect: hash → stream → synthetic)
4. Computes **Harvest Proposals** using P2 Harvest Kernel (`compute_harvest_proposal`)
5. Publishes results to Redis hash (+ optional stream)

**NO trading actions**: Calc-only, no orders, no execution, no modify/close.

---

## Architecture

### Input Sources (Redis)

1. **MarketState** (from P0.5 `quantum-marketstate` service):
   - Key: `quantum:marketstate:<SYMBOL>` (hash)
   - Fields: `sigma`, `ts`, `p_trend`, `p_mr`, `p_chop`

2. **Risk Proposals** (from P1.5 `quantum-risk-proposal` service):
   - Key: `quantum:risk:proposal:<SYMBOL>` (hash)
   - Fields: `stop_dist_pct`, `proposed_sl`
   - Optional: Falls back to `FALLBACK_STOP_PCT=0.02` if missing

3. **Position Snapshots** (auto-detect):
   - Try `quantum:state:positions:<SYMBOL>` (hash)
   - Try `quantum:stream:execution` (stream, last entry per symbol)
   - Fallback to synthetic positions (testing mode)

### Computation

Uses `ai_engine.risk_kernel_harvest.compute_harvest_proposal()`:
- **Inputs**: `PositionSnapshot`, `MarketState`, `P1Proposal`, `HarvestTheta`
- **Outputs**:
  - `harvest_action`: `NONE`, `PARTIAL_25`, `PARTIAL_50`, `PARTIAL_75`, `FULL_CLOSE_PROPOSED`
  - `new_sl_proposed`: Updated stop loss (profit lock BE+)
  - `R_net`: Net profit in risk units
  - `risk_unit`: Position risk size
  - `cost_est`: Estimated trading costs
  - `kill_score`: Kill signal strength (K ∈ [0,1])
  - `reason_codes`: Trigger reasons (harvest, profit_lock, kill_score_triggered, etc.)

### Output (Redis)

1. **Hash** (always published):
   - Key: `quantum:harvest:proposal:<SYMBOL>`
   - Fields:
     ```
     harvest_action          PARTIAL_25
     new_sl_proposed         100.2
     R_net                   2.45
     risk_unit               2.0
     cost_est                0.002
     kill_score              0.503
     reason_codes            harvest_T2,profit_lock
     sigma                   0.015
     ts                      0.45
     p_trend                 0.7
     p_mr                    0.2
     p_chop                  0.1
     computed_at_utc         2026-01-23T14:30:00
     position_side           LONG
     position_age_sec        3600
     position_current_price  105.0
     position_entry_price    100.0
     position_unrealized_pnl 5.0
     ```

2. **Stream** (optional, `ENABLE_STREAM=true`):
   - Key: `quantum:stream:harvest.proposal`
   - Fields: Same as hash + `symbol`
   - Max length: 10000 entries

---

## Rate Limiting

Only publishes if **any** of:
1. `harvest_action` changed (e.g., `NONE` → `PARTIAL_25`)
2. `new_sl_proposed` changed by >0.1% (`CHANGE_EPS_PCT=0.001`)
3. `kill_score` changed by >0.1%
4. Time since last publish > `MAX_PUBLISH_AGE_SEC=60`

This prevents Redis spam while ensuring critical updates are never missed.

---

## Configuration

### Environment File

Location: `/etc/quantum/harvest-proposal.env`

```bash
# Redis connection
REDIS_URL=redis://127.0.0.1:6379/0
REDIS_HOST=127.0.0.1
REDIS_PORT=6379
REDIS_DB=0

# Symbols to monitor (comma-separated)
SYMBOLS=BTCUSDT,ETHUSDT,SOLUSDT

# Publish interval (seconds)
PUBLISH_INTERVAL_SEC=10

# Redis key prefixes
MARKETSTATE_PREFIX=quantum:marketstate:
RISKPROPOSAL_PREFIX=quantum:risk:proposal:
HARVEST_PREFIX=quantum:harvest:proposal:

# Stream configuration
ENABLE_STREAM=false
STREAM_NAME=quantum:stream:harvest.proposal

# Position source (auto|redis_hash|redis_stream|synthetic)
POSITION_SOURCE=auto

# Rate limiting
MAX_PUBLISH_AGE_SEC=60
CHANGE_EPS_PCT=0.001

# Fallback stop loss percentage (if P1 proposal missing)
FALLBACK_STOP_PCT=0.02

# Logging
LOG_LEVEL=INFO
```

### Systemd Service

Location: `/etc/systemd/system/quantum-harvest-proposal.service`

Key properties:
- **User**: `qt`
- **WorkingDirectory**: `/home/qt/quantum_trader`
- **ExecStart**: `/opt/quantum/venvs/ai-engine/bin/python3 .../main.py`
- **EnvironmentFile**: `/etc/quantum/harvest-proposal.env`
- **Restart**: `always` (RestartSec=10s)
- **Dependencies**: `quantum-marketstate.service`, `quantum-risk-proposal.service`, `redis.service`

---

## Deployment

### Manual Deployment (VPS)

```bash
# From local machine, copy files to VPS /tmp (avoids git merge issues)
scp -i ~/.ssh/hetzner_fresh \
    microservices/harvest_proposal_publisher/main.py \
    deployment/systemd/quantum-harvest-proposal.service \
    deployment/config/harvest-proposal.env \
    ops/deploy_harvest_proposal_publisher.sh \
    root@46.224.116.254:/tmp/

# SSH to VPS
ssh -i ~/.ssh/hetzner_fresh root@46.224.116.254

# Move files to proper locations
cd /home/qt/quantum_trader
mkdir -p microservices/harvest_proposal_publisher
cp /tmp/main.py microservices/harvest_proposal_publisher/
cp /tmp/quantum-harvest-proposal.service deployment/systemd/
cp /tmp/harvest-proposal.env deployment/config/
cp /tmp/deploy_harvest_proposal_publisher.sh ops/
chown -R qt:qt microservices/harvest_proposal_publisher ops/deploy_harvest_proposal_publisher.sh

# Run deployment script
bash ops/deploy_harvest_proposal_publisher.sh
```

### Verification

```bash
# 1. Check service status
sudo systemctl status quantum-harvest-proposal

# 2. View logs
sudo journalctl -u quantum-harvest-proposal -n 50 --no-pager

# 3. Check Redis harvest proposals
redis-cli HGETALL quantum:harvest:proposal:BTCUSDT
redis-cli HGETALL quantum:harvest:proposal:ETHUSDT
redis-cli HGETALL quantum:harvest:proposal:SOLUSDT

# 4. Test single cycle (debug mode)
cd /home/qt/quantum_trader
source /opt/quantum/venvs/ai-engine/bin/activate
python3 microservices/harvest_proposal_publisher/main.py --once --position-source synthetic

# 5. Check specific fields
redis-cli HGET quantum:harvest:proposal:BTCUSDT harvest_action
redis-cli HGET quantum:harvest:proposal:BTCUSDT kill_score
redis-cli HGET quantum:harvest:proposal:BTCUSDT R_net
redis-cli HGET quantum:harvest:proposal:BTCUSDT new_sl_proposed
```

---

## Testing

### Local Testing (Windows/WSL)

```bash
# Activate venv
cd c:\quantum_trader
# or WSL: cd /mnt/c/quantum_trader

# Test with synthetic positions (no real data required)
python3 microservices/harvest_proposal_publisher/main.py \
    --once \
    --position-source synthetic \
    --symbols BTCUSDT

# Expected output:
# - Reads MarketState (if available) or uses defaults
# - Generates synthetic position (LONG, 5% profit)
# - Computes harvest proposal (likely PARTIAL_25 with R_net ~2.5)
# - Publishes to Redis: quantum:harvest:proposal:BTCUSDT
```

### Integration Testing (VPS)

```bash
# Prerequisites:
# - quantum-marketstate.service running (P0.5)
# - quantum-risk-proposal.service running (P1.5)
# - Redis running with data

# Test single cycle
python3 microservices/harvest_proposal_publisher/main.py --once

# Expected behavior:
# - Reads MarketState from quantum:marketstate:BTCUSDT
# - Reads risk proposal from quantum:risk:proposal:BTCUSDT
# - Reads position (auto-detect)
# - Computes harvest proposal
# - Publishes to quantum:harvest:proposal:BTCUSDT

# Verify output
redis-cli HGETALL quantum:harvest:proposal:BTCUSDT
# Should show: harvest_action, new_sl_proposed, R_net, kill_score, reason_codes
```

---

## P2.5B Proof Pack (TODO)

After VPS deployment, run 7-part proof pack:

### PROOF 1: Calc-only Import Hygiene
```bash
# AST import analysis
python3 - <<'PY'
import ast
p="microservices/harvest_proposal_publisher/main.py"
t=ast.parse(open(p,"r",encoding="utf-8").read())
imports=[n for n in ast.walk(t) if isinstance(n,(ast.Import,ast.ImportFrom))]
for imp in imports:
    print(f"{type(imp).__name__}: {getattr(imp,'module',None)} - {[a.name for a in imp.names]}")
PY
```
**Expected**: Only stdlib + redis + ai_engine.risk_kernel_harvest (calc-only)

### PROOF 2: Systemd Service Active
```bash
sudo systemctl is-active quantum-harvest-proposal
```
**Expected**: `active`

### PROOF 3: P0.5 MarketState Data Exists
```bash
redis-cli HGETALL quantum:marketstate:BTCUSDT | grep -E "sigma|ts|p_trend"
```
**Expected**: Valid float values for sigma, ts, p_trend

### PROOF 4: P1.5 Risk Proposals Exist (or fallback works)
```bash
redis-cli HGETALL quantum:risk:proposal:BTCUSDT | grep stop_dist_pct
```
**Expected**: Valid stop_dist_pct OR service logs show fallback to 0.02

### PROOF 5: P2.5 Harvest Proposals Published
```bash
redis-cli HGETALL quantum:harvest:proposal:BTCUSDT
redis-cli HGETALL quantum:harvest:proposal:ETHUSDT
redis-cli HGETALL quantum:harvest:proposal:SOLUSDT
```
**Expected**: All symbols have proposals with harvest_action, R_net, kill_score

### PROOF 6: --once Mode Works
```bash
cd /home/qt/quantum_trader
source /opt/quantum/venvs/ai-engine/bin/activate
python3 microservices/harvest_proposal_publisher/main.py --once --position-source synthetic 2>&1 | grep "Single cycle complete"
```
**Expected**: Exit 0, log shows "Single cycle complete"

### PROOF 7: Rate Limiting (10s interval)
```bash
# Watch logs for 30s
sudo journalctl -u quantum-harvest-proposal -f -n 0 &
sleep 30
# Count "Published harvest" lines
sudo journalctl -u quantum-harvest-proposal --since "30 seconds ago" | grep "Published harvest" | wc -l
```
**Expected**: ~3 publish cycles (one every 10s), unless rate-limited

---

## Harvest Kernel Logic Summary

For reference, the P2 Harvest Kernel computes:

### R_net (Risk-Normalized Profit)
```python
risk_unit = entry_price * stop_dist_pct
R_net = (unrealized_pnl - cost_est) / risk_unit
```

### Harvest Action (based on R_net)
- `R_net < T1_R (2.0)`: `NONE`
- `R_net >= T1_R`: `PARTIAL_25` (25% exit)
- `R_net >= T2_R (4.0)`: `PARTIAL_50` (50% exit)
- `R_net >= T3_R (6.0)`: `PARTIAL_75` (75% exit)

### Profit Lock (BE+ stop tightening)
```python
if R_net >= lock_R (1.5):
    new_sl = entry_price * (1 + lock_R * stop_dist_pct) for LONG
    # Monotonic: only tighten, never loosen
```

### Kill Score (K ∈ [0,1])
```python
K = sigmoid(
    k_regime_flip * regime_flip +
    k_sigma_spike * sigma_spike +
    k_ts_drop * ts_drop +
    k_age_penalty * age_penalty
)

if K >= kill_threshold (0.6):
    harvest_action = FULL_CLOSE_PROPOSED
```

See [ai_engine/risk_kernel_harvest.py](../ai_engine/risk_kernel_harvest.py) for full implementation.

---

## Dependencies

### Upstream (Required)
- **P0.5**: MarketState Publisher (`quantum-marketstate.service`)
  - Provides: `quantum:marketstate:<SYMBOL>` (sigma, ts, regime probs)
- **P1.5**: Risk Proposal Publisher (`quantum-risk-proposal.service`)
  - Provides: `quantum:risk:proposal:<SYMBOL>` (stop_dist_pct)
- **P2**: Harvest Kernel (`ai_engine/risk_kernel_harvest.py`)
  - Provides: `compute_harvest_proposal()` calc-only function

### Downstream (Optional)
- **Dashboard**: Can display harvest proposals (action, R_net, K)
- **P3+ Apply Layer**: Can execute harvest proposals (MODIFY/CLOSE under safety gates)

---

## Troubleshooting

### Service fails to start
```bash
# Check logs
sudo journalctl -u quantum-harvest-proposal -n 100 --no-pager

# Common issues:
# 1. Python venv missing: Install with python3 -m venv /opt/quantum/venvs/ai-engine
# 2. Redis connection failed: Check REDIS_URL in /etc/quantum/harvest-proposal.env
# 3. Import error: Verify PYTHONPATH=/home/qt/quantum_trader in service file
```

### No proposals published
```bash
# Check dependencies
systemctl is-active quantum-marketstate  # Should be active
systemctl is-active quantum-risk-proposal  # Should be active
redis-cli PING  # Should return PONG

# Check MarketState data
redis-cli HGETALL quantum:marketstate:BTCUSDT

# Check position source
python3 microservices/harvest_proposal_publisher/main.py --once --position-source synthetic
# If synthetic works but auto doesn't, position data is missing
```

### Rate limiting too aggressive
```bash
# Edit config
sudo nano /etc/quantum/harvest-proposal.env
# Set:
#   MAX_PUBLISH_AGE_SEC=30  (was 60)
#   CHANGE_EPS_PCT=0.0001   (was 0.001, more sensitive)

# Restart
sudo systemctl restart quantum-harvest-proposal
```

---

## Next Steps (P2.5B)

1. **Deploy to VPS**: Use manual `/tmp` method (same as P1.5B, P2B)
2. **Run proof pack**: 7 proofs documenting calc-only hygiene, service health, data flow
3. **Create proof pack report**: `P2.5B_VPS_PROOF_PACK_COMPLETE.md`
4. **Commit and LOCK**: P2.5 becomes locked spec after proof pack passes

After P2.5B:
- **P3**: Apply Layer (MODIFY/CLOSE under safety gates)
- **Dashboard Integration**: Display harvest proposals alongside stops/trailing

---

## Files Created

```
microservices/harvest_proposal_publisher/
  main.py                                    (521 lines, calc-only publisher)

deployment/systemd/
  quantum-harvest-proposal.service           (systemd unit file)

deployment/config/
  harvest-proposal.env                       (config with all tunables)

ops/
  deploy_harvest_proposal_publisher.sh       (VPS deployment script)

docs/
  P2.5_HARVEST_PROPOSAL_PUBLISHER.md         (this file)
```

---

## Change Log

- **2026-01-23**: Initial implementation (main.py, systemd service, config, deployment script, docs)
- **Next**: VPS deployment and P2.5B proof pack

---

**Status**: ✅ Implementation complete, awaiting VPS deployment  
**Next Phase**: P2.5B (VPS DEPLOY + PROOF PACK)
