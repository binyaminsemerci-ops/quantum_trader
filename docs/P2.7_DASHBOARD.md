# P2.7 Harvest Dashboard - Prometheus + Grafana

**Phase:** P2.7 (Observability Layer)  
**Date:** 2026-01-23  
**Status:** Ready for deployment  

---

## Overview

P2.7 adds Prometheus metrics exporter and Grafana dashboard for real-time visualization of harvest proposals and kill score components.

### Architecture

```
┌─────────────────────────────────────────────────────────┐
│                    P2.7 ARCHITECTURE                     │
└─────────────────────────────────────────────────────────┘

Redis Hashes                  Exporter                  Prometheus
quantum:harvest:             :8042/metrics              :9090
proposal:BTCUSDT    ──────►  HTTP Server   ──────►     Scraper
proposal:ETHUSDT             (every 5s)                 (every 10s)
proposal:SOLUSDT                  │
                                  │
                                  ▼
                              Grafana :3001
                              Dashboard Panels
```

---

## Components

### 1. Harvest Metrics Exporter

**File:** `microservices/harvest_metrics_exporter/main.py`

**Purpose:** Read harvest proposals from Redis and expose as Prometheus metrics

**Features:**
- ✅ Reads from Redis hashes (`quantum:harvest:proposal:<SYMBOL>`)
- ✅ Caches data (refreshes every 5s)
- ✅ HTTP server on port 8042
- ✅ Prometheus text exposition format
- ✅ Robust parsing (defaults to 0.0 for missing fields)
- ✅ Runs as systemd service

**Dependencies:**
- Python stdlib (`http.server`, `threading`)
- `redis` library (with subprocess fallback to `redis-cli`)

**Endpoints:**
- `/metrics` - Prometheus metrics
- `/health` - Health check

---

## Metrics Exported

### Kill Score Metrics

| Metric | Type | Description | Range |
|--------|------|-------------|-------|
| `quantum_harvest_kill_score{symbol}` | gauge | Kill score (edge collapse indicator) | 0-1 |
| `quantum_harvest_k_regime_flip{symbol}` | gauge | Regime transition component | 0 or 1 |
| `quantum_harvest_k_sigma_spike{symbol}` | gauge | Volatility spike component | 0-2 |
| `quantum_harvest_k_ts_drop{symbol}` | gauge | Trend strength drop component | 0-0.5 |
| `quantum_harvest_k_age_penalty{symbol}` | gauge | Position age penalty | 0-1 |

### Harvest Proposal Metrics

| Metric | Type | Description |
|--------|------|-------------|
| `quantum_harvest_r_net{symbol}` | gauge | Net risk-reward ratio |
| `quantum_harvest_new_sl{symbol}` | gauge | Proposed new stop loss |
| `quantum_harvest_action{symbol,action}` | gauge | Harvest action (one-hot encoded) |
| `quantum_harvest_last_update_epoch{symbol}` | gauge | Last update timestamp |

### Action One-Hot Encoding

Actions: `NONE`, `PARTIAL_25`, `PARTIAL_50`, `PARTIAL_75`, `FULL_CLOSE_PROPOSED`

Example:
```
quantum_harvest_action{symbol="ETHUSDT",action="FULL_CLOSE_PROPOSED"} 1.0
quantum_harvest_action{symbol="ETHUSDT",action="PARTIAL_75"} 0.0
quantum_harvest_action{symbol="ETHUSDT",action="PARTIAL_50"} 0.0
quantum_harvest_action{symbol="ETHUSDT",action="PARTIAL_25"} 0.0
quantum_harvest_action{symbol="ETHUSDT",action="NONE"} 0.0
```

---

## Deployment

### Step 1: Deploy Exporter Service

**On VPS:**

```bash
# 1. Copy files
scp microservices/harvest_metrics_exporter/main.py root@VPS:/tmp/harvest_exporter.py
scp deployment/config/harvest-metrics-exporter.env root@VPS:/tmp/
scp deployment/systemd/quantum-harvest-metrics-exporter.service root@VPS:/tmp/

# 2. Install
ssh root@VPS "
  mkdir -p /home/qt/quantum_trader/microservices/harvest_metrics_exporter
  cp /tmp/harvest_exporter.py /home/qt/quantum_trader/microservices/harvest_metrics_exporter/main.py
  chown -R qt:qt /home/qt/quantum_trader/microservices/harvest_metrics_exporter
  
  cp /tmp/harvest-metrics-exporter.env /etc/quantum/
  chmod 640 /etc/quantum/harvest-metrics-exporter.env
  chown qt:qt /etc/quantum/harvest-metrics-exporter.env
  
  cp /tmp/quantum-harvest-metrics-exporter.service /etc/systemd/system/
  chmod 644 /etc/systemd/system/quantum-harvest-metrics-exporter.service
"

# 3. Start service
ssh root@VPS "
  systemctl daemon-reload
  systemctl enable quantum-harvest-metrics-exporter.service
  systemctl start quantum-harvest-metrics-exporter.service
  sleep 3
  systemctl status quantum-harvest-metrics-exporter.service
"

# 4. Verify metrics
ssh root@VPS "curl -s http://127.0.0.1:8042/metrics | head -50"
```

### Step 2: Configure Prometheus Scrape Job

**Find Prometheus config:**
```bash
# Common locations:
# - /etc/prometheus/prometheus.yml (systemd)
# - /opt/prometheus/prometheus.yml (manual)
# - Docker bind mount (check docker inspect)
```

**Add scrape job to `prometheus.yml`:**
```yaml
scrape_configs:
  # ... existing jobs ...
  
  - job_name: 'quantum-harvest-exporter'
    static_configs:
      - targets: ['127.0.0.1:8042']
    scrape_interval: 10s
    scrape_timeout: 5s
```

**Reload Prometheus:**
```bash
# Systemd
systemctl reload prometheus

# Docker
docker kill -s HUP quantum_prometheus
# OR
docker restart quantum_prometheus
```

**Verify scrape:**
```bash
# Check Prometheus targets UI
http://PROMETHEUS_URL:9090/targets

# Or query via API
curl -s 'http://localhost:9090/api/v1/query?query=quantum_harvest_kill_score' | jq
```

### Step 3: Import Grafana Dashboard

**Option A: Grafana API (Automated)**

```bash
# Set variables
GRAFANA_URL="http://localhost:3001"
GRAFANA_API_KEY="your-api-key"  # Create in Grafana UI: Configuration → API Keys

# Import dashboard
curl -X POST \
  -H "Authorization: Bearer ${GRAFANA_API_KEY}" \
  -H "Content-Type: application/json" \
  -d @deployment/grafana/quantum_harvest_control_p27.json \
  "${GRAFANA_URL}/api/dashboards/db"
```

**Option B: Manual Import**

1. Open Grafana: `http://localhost:3001` (or VPS:3001)
2. Login: admin / QuantumTrader2024!
3. Navigate: **Dashboards → Import**
4. Upload JSON: `deployment/grafana/quantum_harvest_control_p27.json`
5. Select Prometheus datasource
6. Click **Import**

---

## Dashboard Panels

### Row 1: Overview

**Panel 1: Kill Score Gauge**
- Type: Gauge
- Metric: `quantum_harvest_kill_score`
- Threshold: Red if >= 0.6
- Shows all symbols

**Panel 2: R_net Stat**
- Type: Stat
- Metric: `quantum_harvest_r_net`
- Color: Green if >= 7, Yellow if >= 3, Red if < 3

**Panel 3: New SL Stat**
- Type: Stat
- Metric: `quantum_harvest_new_sl`
- Shows proposed stop loss per symbol

### Row 2: Kill Score Components

**Panels 4-6: Component Timeseries (per symbol)**
- Type: Timeseries (stacked area)
- Metrics:
  - `quantum_harvest_k_regime_flip` (Regime Flip, weight 2.0x)
  - `quantum_harvest_k_sigma_spike` (Sigma Spike, weight 1.5x)
  - `quantum_harvest_k_ts_drop` (TS Drop, weight 2.5x)
  - `quantum_harvest_k_age_penalty` (Age Penalty, weight 0.5x)
- Shows component breakdown over time

### Row 3: Actions Table

**Panel 7: Summary Table**
- Type: Table
- Columns: Symbol, Kill Score, R_net, New SL, Regime Flip, TS Drop
- Kill Score cell: Color background (green < 0.6, red >= 0.6)
- Instant queries (current values)

---

## Example Queries

### Basic Metrics

```promql
# Kill scores for all symbols
quantum_harvest_kill_score

# Kill score for specific symbol
quantum_harvest_kill_score{symbol="ETHUSDT"}

# R_net ratio
quantum_harvest_r_net{symbol="BTCUSDT"}
```

### Component Analysis

```promql
# Regime flip status
quantum_harvest_k_regime_flip{symbol="ETHUSDT"}

# Sum of all components (weighted)
sum by(symbol) (
  quantum_harvest_k_regime_flip * 2.0 +
  quantum_harvest_k_sigma_spike * 1.5 +
  quantum_harvest_k_ts_drop * 2.5 +
  quantum_harvest_k_age_penalty * 0.5
)
```

### Action Queries

```promql
# Current action (which one-hot is 1)
max by(symbol, action) (quantum_harvest_action)

# Count FULL_CLOSE proposals
sum(quantum_harvest_action{action="FULL_CLOSE_PROPOSED"})

# Symbols in PARTIAL_75 state
quantum_harvest_action{action="PARTIAL_75"} == 1
```

### Staleness

```promql
# Time since last update (seconds)
time() - quantum_harvest_last_update_epoch

# Stale data alert (>60s)
(time() - quantum_harvest_last_update_epoch) > 60
```

---

## Verification Checklist

### ✅ Exporter Health

```bash
# Service running
systemctl status quantum-harvest-metrics-exporter

# Metrics endpoint responding
curl -s http://127.0.0.1:8042/metrics | grep quantum_harvest_kill_score

# Health check
curl -s http://127.0.0.1:8042/health
# Expected: OK
```

### ✅ Prometheus Integration

```bash
# Check Prometheus config
grep -A 3 "quantum-harvest-exporter" /etc/prometheus/prometheus.yml

# Query Prometheus
curl -s 'http://localhost:9090/api/v1/query?query=quantum_harvest_kill_score' \
  | jq '.data.result[] | {symbol: .metric.symbol, value: .value[1]}'

# Check targets (should show UP)
curl -s 'http://localhost:9090/api/v1/targets' \
  | jq '.data.activeTargets[] | select(.job=="quantum-harvest-exporter")'
```

### ✅ Grafana Dashboard

```bash
# List dashboards
curl -s -H "Authorization: Bearer ${GRAFANA_API_KEY}" \
  "${GRAFANA_URL}/api/search?query=Harvest" | jq

# Get dashboard
curl -s -H "Authorization: Bearer ${GRAFANA_API_KEY}" \
  "${GRAFANA_URL}/api/dashboards/uid/<UID>" | jq '.dashboard.title'
```

**Manual Check:**
1. Open Grafana UI
2. Navigate to "Quantum — Harvest Control (P2.7)"
3. Verify panels load data
4. Check time range (Last 1 hour recommended)
5. Verify refresh is working (10s auto-refresh)

---

## Example Metrics Output

```prometheus
# HELP quantum_harvest_kill_score Kill score (edge collapse indicator)
# TYPE quantum_harvest_kill_score gauge
quantum_harvest_kill_score{symbol="BTCUSDT"} 0.527
quantum_harvest_kill_score{symbol="ETHUSDT"} 0.753
quantum_harvest_kill_score{symbol="SOLUSDT"} 0.761

# HELP quantum_harvest_k_regime_flip Regime flip component (0 or 1)
# TYPE quantum_harvest_k_regime_flip gauge
quantum_harvest_k_regime_flip{symbol="BTCUSDT"} 0.0
quantum_harvest_k_regime_flip{symbol="ETHUSDT"} 1.0
quantum_harvest_k_regime_flip{symbol="SOLUSDT"} 1.0

# HELP quantum_harvest_k_ts_drop Trend strength drop component (0-0.5)
# TYPE quantum_harvest_k_ts_drop gauge
quantum_harvest_k_ts_drop{symbol="BTCUSDT"} 0.055
quantum_harvest_k_ts_drop{symbol="ETHUSDT"} 0.208
quantum_harvest_k_ts_drop{symbol="SOLUSDT"} 0.286

# HELP quantum_harvest_action Harvest action (one-hot encoded)
# TYPE quantum_harvest_action gauge
quantum_harvest_action{symbol="BTCUSDT",action="PARTIAL_75"} 1.0
quantum_harvest_action{symbol="BTCUSDT",action="FULL_CLOSE_PROPOSED"} 0.0
quantum_harvest_action{symbol="ETHUSDT",action="PARTIAL_75"} 0.0
quantum_harvest_action{symbol="ETHUSDT",action="FULL_CLOSE_PROPOSED"} 1.0
```

---

## Troubleshooting

### Exporter Not Starting

```bash
# Check logs
journalctl -u quantum-harvest-metrics-exporter -n 100 --no-pager

# Common issues:
# 1. Redis connection failed → Check REDIS_HOST/PORT in env file
# 2. Port 8042 in use → Change METRICS_PORT or kill conflicting process
# 3. Python venv missing redis → Install: pip install redis
```

### Metrics Not Appearing in Prometheus

```bash
# 1. Check Prometheus targets
curl -s http://localhost:9090/api/v1/targets | jq '.data.activeTargets[] | select(.job=="quantum-harvest-exporter")'

# 2. Verify exporter metrics endpoint
curl -s http://127.0.0.1:8042/metrics | grep quantum_harvest

# 3. Check Prometheus logs
journalctl -u prometheus -n 50 --no-pager

# 4. Verify scrape config
prometheus --config.file=/etc/prometheus/prometheus.yml --check-config
```

### Grafana Dashboard Blank

```bash
# 1. Check Prometheus datasource in Grafana
curl -s -H "Authorization: Bearer ${GRAFANA_API_KEY}" \
  "${GRAFANA_URL}/api/datasources" | jq '.[] | select(.type=="prometheus")'

# 2. Test query in Grafana Explore
# Query: quantum_harvest_kill_score

# 3. Check time range (default Last 1 hour)

# 4. Verify data exists in Prometheus
curl -s 'http://localhost:9090/api/v1/query?query=quantum_harvest_kill_score'
```

---

## Next Steps

### Immediate
- ✅ Deploy exporter service
- ✅ Configure Prometheus scrape
- ✅ Import Grafana dashboard
- ✅ Verify all panels load

### Short-Term
- Add alerting rules (K > 0.6, stale data >60s)
- Add recording rules (pre-computed aggregations)
- Add more panels (historical trends, distributions)

### Medium-Term
- P3 Apply Layer dashboard (execution metrics)
- Unified Quantum Trader Overview dashboard
- Mobile-friendly dashboard layout

---

## Files Created

```
microservices/harvest_metrics_exporter/
  └── main.py                                    (Metrics exporter service)

deployment/
  ├── config/
  │   └── harvest-metrics-exporter.env           (Environment config)
  ├── systemd/
  │   └── quantum-harvest-metrics-exporter.service  (Systemd unit)
  └── grafana/
      └── quantum_harvest_control_p27.json       (Dashboard JSON)

docs/
  └── P2.7_DASHBOARD.md                          (This file)
```

---

**Status:** Ready for deployment  
**Phase:** P2.7 (Observability)  
**Dependencies:** P2.6B (k_components in Redis)  
**Next:** P3 Apply Layer (first trading actions)
