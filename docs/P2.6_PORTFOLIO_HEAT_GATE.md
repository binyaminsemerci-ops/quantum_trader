# P2.6 Portfolio Heat Gate

## Overview

P2.6 Portfolio Heat Gate is a **shadow-first, fail-open** microservice that moderates harvest exit/close actions based on real-time portfolio heat levels. It prevents false or panic FULL_CLOSE actions by recommending downgrades to partial closes (PARTIAL_50, PARTIAL_25) when portfolio risk indicators are elevated.

**Key Properties**:
- **Shadow-first**: Does NOT modify harvest proposals; publishes parallel decision stream
- **Fail-open**: Missing/stale inputs → no moderation, action passes through unchanged
- **Deterministic**: No randomness; reproducible from inputs
- **Exchange-agnostic**: Operates purely on Redis data; no Binance credentials required

## Architecture Position

P2.6 sits **after** P2.5 Harvest Engine in the pipeline:

```
P2.5 Harvest Engine
  ↓ (publishes to quantum:stream:harvest.proposal)
P2.6 Heat Gate ← reads harvest proposals
  ↓ (publishes to quantum:stream:harvest.heat.decision)
[Future: Governor or Apply Engine reads heat decisions]
```

Heat Gate does NOT block execution; it provides **advisory signals** for downstream components.

## Redis Schemas

### Input: Harvest Proposal Stream
**Stream**: `quantum:stream:harvest.proposal`  
**Fields** (read-only):
- `plan_id`: Unique plan identifier
- `symbol`: Trading pair (e.g., BTCUSDT)
- `action`: Harvest action (e.g., FULL_CLOSE_PROPOSED, PARTIAL_75_PROPOSED)
- `decision`: EXECUTE or other
- `kill_score`: Float 0-1 (risk/urgency score)
- `ts_epoch`: Timestamp

### Input: Portfolio State
**Key**: `quantum:portfolio:state` (HASH)  
**Fields**:
- `ts_epoch`: State timestamp
- `net_exposure_usd`: Net portfolio exposure
- `gross_exposure_usd`: Gross portfolio exposure
- `dd_ewma_usd`: Drawdown EWMA (recent losses)
- `lossburst_ewma_usd`: Loss burst EWMA (recent rapid losses)
- `fee_burden_ewma_usd`: Fee/turnover burden EWMA
- `churn_ewma`: Position churn rate EWMA

**Staleness**: If `ts_epoch` older than `STALE_SEC` (default 600s), inputs ignored → fail-open.

### Output: Heat Decision Stream
**Stream**: `quantum:stream:harvest.heat.decision`  
**Fields**:
- `ts_epoch`: Decision timestamp
- `symbol`: Trading pair
- `plan_id`: Original plan ID from harvest proposal
- `in_action`: Original action from harvest proposal
- `out_action`: Moderated action (same as `in_action` if no moderation)
- `heat_level`: "cold" | "warm" | "hot" | "unknown"
- `heat_score`: Float 0-1 (portfolio risk score)
- `heat_action`: "NONE" | "DOWNGRADE_FULL_TO_PARTIAL" | "HOLD_CLOSE"
- `recommended_partial`: 0.50 (warm) or 0.25 (hot), empty if not applicable
- `reason`: "ok" | "missing_inputs" | "stale_inputs" | "redis_error" | etc.
- `inputs_age_sec`: Age of portfolio state in seconds (or empty)
- `mode`: "shadow" (always)
- `debug_json`: Small JSON blob with component scores (<= 400 chars)

### Output: Shadow Key
**Key**: `quantum:harvest:heat:{symbol}` (HASH, TTL 600s)  
**Fields**:
- `ts_epoch`
- `last_plan_id`
- `heat_level`
- `heat_score`
- `heat_action`
- `out_action`
- `recommended_partial`
- `reason`
- `debug_json`

## Heat Calculation

### Component Scores (each 0-1)
```
exposure01 = clamp01(gross_exposure_usd / GROSS_TARGET_USD)
dd01       = clamp01(dd_ewma_usd / DD_TARGET_USD)
burst01    = clamp01(lossburst_ewma_usd / BURST_TARGET_USD)
fee01      = clamp01(fee_burden_ewma_usd / FEE_TARGET_USD)
churn01    = clamp01(churn_ewma / CHURN_TARGET)
```

### Heat Score
```
heat_raw = W_EXP*exposure01 + W_DD*dd01 + W_BURST*burst01 + W_FEE*fee01 + W_CHURN*churn01
heat_score = clamp01(heat_raw / (W_EXP + W_DD + W_BURST + W_FEE + W_CHURN))
```

### Heat Level
- **cold**: `heat_score < T_WARM` (default 0.45)
- **warm**: `T_WARM <= heat_score < T_HOT` (default 0.70)
- **hot**: `heat_score >= T_HOT`
- **unknown**: Missing/stale portfolio state

## Moderation Policy

**Rules** (shadow-only, never blocks execution):

1. **If `in_action` != "FULL_CLOSE_PROPOSED"**: 
   - `heat_action` = "NONE"
   - `out_action` = `in_action` (unchanged)

2. **If `in_action` == "FULL_CLOSE_PROPOSED"**:
   - **cold**: No moderation (`heat_action` = "NONE")
   - **warm**: `heat_action` = "DOWNGRADE_FULL_TO_PARTIAL", `out_action` = "PARTIAL_50_PROPOSED", `recommended_partial` = 0.50
   - **hot**: `heat_action` = "DOWNGRADE_FULL_TO_PARTIAL", `out_action` = "PARTIAL_25_PROPOSED", `recommended_partial` = 0.25
   - **unknown**: Fail-open (`heat_action` = "NONE", `out_action` = `in_action`)

3. **Hold-Close** (analytics marker only, optional):
   - If `ENABLE_HOLD_CLOSE=true` AND `kill_score < HOLD_KILL_MAX` AND `heat_level=hot`:
     - `heat_action` = "HOLD_CLOSE"
     - `out_action` = "HOLD_CLOSE_SHADOW"
   - This is a **shadow-only marker** for analytics; never blocks execution.

## Environment Variables

### Connection
- `REDIS_HOST` (default: localhost)
- `REDIS_PORT` (default: 6379)
- `HEAT_METRICS_PORT` (default: 8068)
- `HEAT_HEALTH_PORT` (default: 8069)

### Stream Config
- `HEAT_STREAM_IN` (default: quantum:stream:harvest.proposal)
- `HEAT_STREAM_OUT` (default: quantum:stream:harvest.heat.decision)
- `HEAT_GROUP` (default: heat_gate)
- `HEAT_CONSUMER` (default: heat_gate_1)
- `HEAT_POLL_MS` (default: 500)
- `HEAT_STATE_KEY` (default: quantum:portfolio:state)
- `STALE_SEC` (default: 600)

### Targets (safe defaults for moderate-risk portfolio)
- `GROSS_TARGET_USD` (default: 5000)
- `DD_TARGET_USD` (default: 250)
- `BURST_TARGET_USD` (default: 250)
- `FEE_TARGET_USD` (default: 50)
- `CHURN_TARGET` (default: 1.0)

### Weights
- `W_EXP` (default: 1.0)
- `W_DD` (default: 1.0)
- `W_BURST` (default: 1.0)
- `W_FEE` (default: 0.5)
- `W_CHURN` (default: 0.5)

### Thresholds & Partials
- `T_WARM` (default: 0.45)
- `T_HOT` (default: 0.70)
- `WARM_PARTIAL` (default: 0.50)
- `HOT_PARTIAL` (default: 0.25)

### Hold-Close (shadow marker)
- `ENABLE_HOLD_CLOSE` (default: false)
- `HOLD_KILL_MAX` (default: 0.30)

## Deployment

### 1. Copy Config
```bash
sudo cp deployment/config/heat-gate.env /etc/quantum/
```

### 2. Install Systemd Service
```bash
sudo cp deployment/systemd/quantum-heat-gate.service /etc/systemd/system/
sudo systemctl daemon-reload
sudo systemctl enable quantum-heat-gate
```

### 3. Start Service
```bash
sudo systemctl start quantum-heat-gate
sudo systemctl status quantum-heat-gate
```

### 4. Verify Metrics
```bash
curl -s http://localhost:8068/metrics | grep p26_
```

### 5. Verify Health
```bash
curl -s http://localhost:8069/health
```

## Proof Scripts

### Inject Helper
```bash
# Clear state
python3 scripts/proof_p26_inject_state.py clear

# Inject portfolio state
python3 scripts/proof_p26_inject_state.py state <gross> <dd> <burst> <fee> <churn>

# Inject harvest proposal
python3 scripts/proof_p26_inject_state.py proposal <symbol> <action> <kill_score>
```

### Run Proof
```bash
bash scripts/proof_p26_heat_gate.sh
```

**Tests**:
1. COLD portfolio → FULL_CLOSE unchanged
2. WARM portfolio → FULL_CLOSE → PARTIAL_50
3. HOT portfolio → FULL_CLOSE → PARTIAL_25
4. Missing state → Fail-open (FULL_CLOSE unchanged)

**Exit codes**: 0 = PASS, 1 = FAIL

## Metrics (Prometheus)

**Prefix**: `p26_`

- `p26_loops_total`: Event loop iterations
- `p26_in_messages_total{action=...}`: Incoming harvest proposals by action
- `p26_out_messages_total{heat_action=...,heat_level=...}`: Outgoing decisions by action and heat level
- `p26_heat_score{symbol=...}`: Last heat score per symbol (gauge)
- `p26_failopen_total{reason=...}`: Fail-open events by reason

## Health Endpoint

**URL**: `http://localhost:8069/health`

**Response** (JSON):
```json
{
  "status": "ok",
  "ts_epoch": 1738036800,
  "last_loop_ms": 15
}
```

## Examples

### Example 1: Cold Portfolio (No Moderation)
**Input (portfolio state)**:
```
gross_exposure_usd: 1000 (target 5000 → 0.2)
dd_ewma_usd: 50 (target 250 → 0.2)
burst_ewma_usd: 50 (target 250 → 0.2)
fee_ewma_usd: 10 (target 50 → 0.2)
churn_ewma: 0.2 (target 1.0 → 0.2)
```

**Calculation**:
```
heat_score = (1.0*0.2 + 1.0*0.2 + 1.0*0.2 + 0.5*0.2 + 0.5*0.2) / 4.0 = 0.2
heat_level = "cold" (< 0.45)
```

**Input (harvest proposal)**:
```
action: FULL_CLOSE_PROPOSED
```

**Output (heat decision)**:
```
heat_action: NONE
out_action: FULL_CLOSE_PROPOSED (unchanged)
reason: ok
```

### Example 2: Warm Portfolio (Downgrade to 50%)
**Input (portfolio state)**:
```
gross_exposure_usd: 2500 (0.5)
dd_ewma_usd: 125 (0.5)
burst_ewma_usd: 125 (0.5)
fee_ewma_usd: 25 (0.5)
churn_ewma: 0.5 (0.5)
```

**Calculation**:
```
heat_score = (1.0*0.5 + 1.0*0.5 + 1.0*0.5 + 0.5*0.5 + 0.5*0.5) / 4.0 = 0.5
heat_level = "warm" (0.45 <= 0.5 < 0.70)
```

**Input (harvest proposal)**:
```
action: FULL_CLOSE_PROPOSED
```

**Output (heat decision)**:
```
heat_action: DOWNGRADE_FULL_TO_PARTIAL
out_action: PARTIAL_50_PROPOSED
recommended_partial: 0.50
reason: ok
```

### Example 3: Hot Portfolio (Downgrade to 25%)
**Input (portfolio state)**:
```
gross_exposure_usd: 4000 (0.8)
dd_ewma_usd: 200 (0.8)
burst_ewma_usd: 200 (0.8)
fee_ewma_usd: 40 (0.8)
churn_ewma: 0.8 (0.8)
```

**Calculation**:
```
heat_score = (1.0*0.8 + 1.0*0.8 + 1.0*0.8 + 0.5*0.8 + 0.5*0.8) / 4.0 = 0.8
heat_level = "hot" (>= 0.70)
```

**Input (harvest proposal)**:
```
action: FULL_CLOSE_PROPOSED
```

**Output (heat decision)**:
```
heat_action: DOWNGRADE_FULL_TO_PARTIAL
out_action: PARTIAL_25_PROPOSED
recommended_partial: 0.25
reason: ok
```

### Example 4: Missing State (Fail-Open)
**Input (portfolio state)**:
```
[Not present or stale]
```

**Input (harvest proposal)**:
```
action: FULL_CLOSE_PROPOSED
```

**Output (heat decision)**:
```
heat_action: NONE
out_action: FULL_CLOSE_PROPOSED (unchanged)
heat_level: unknown
reason: missing_inputs
```

## Troubleshooting

### Check Service Status
```bash
systemctl status quantum-heat-gate
journalctl -u quantum-heat-gate -n 50 --no-pager
```

### Check Metrics
```bash
curl -s http://localhost:8068/metrics | grep p26_
```

### Check Portfolio State
```bash
redis-cli HGETALL quantum:portfolio:state
```

### Check Heat Decisions
```bash
redis-cli XREVRANGE quantum:stream:harvest.heat.decision + - COUNT 5
```

### Check Shadow Key
```bash
redis-cli HGETALL quantum:harvest:heat:BTCUSDT
```

### Common Issues
1. **No heat decisions appearing**: Check if harvest proposals stream has data
2. **Always "unknown" heat level**: Check if portfolio state exists and is recent
3. **Service not starting**: Check logs for Redis connection errors
4. **Metrics not responding**: Verify port 8068 is not in use

## Integration Notes

- **Upstream**: P2.5 Harvest Engine publishes to `quantum:stream:harvest.proposal`
- **Downstream**: Governor or Apply Engine can read `quantum:stream:harvest.heat.decision` to respect moderation signals
- **Shadow-first**: Current implementation does NOT modify harvest behavior; future components can integrate heat signals
- **Fail-open**: Missing/stale portfolio state → no moderation applied → harvest action proceeds unchanged

## Future Enhancements

1. **Live Portfolio State Computation**: Compute `quantum:portfolio:state` from execution results (currently injected for proof)
2. **Dynamic Thresholds**: Adjust `T_WARM`/`T_HOT` based on market volatility
3. **Symbol-Specific Weights**: Different weight profiles for different assets
4. **Integration with Governor**: Governor reads heat decisions and applies moderation to permits
5. **ML-Based Heat**: Replace deterministic formula with trained model (retain fail-open property)
