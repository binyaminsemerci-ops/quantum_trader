# P2.7 - Grafana Dashboard Manual Import Guide

## Quick Import (5 Minutes)

### Method 1: Via Grafana Web UI (Easiest)

1. **Access Grafana**:
   ```
   URL: http://46.224.116.254:3001
   Username: admin
   Password: QuantumTrader2024!
   ```

2. **Navigate to Import**:
   - Click "Dashboards" in left sidebar (4 squares icon)
   - Click "Import" button (top right)

3. **Upload Dashboard JSON**:
   - Click "Upload JSON file"
   - Select file: `c:\quantum_trader\deployment\grafana\quantum_harvest_control_p27.json`
   - OR copy file content and paste into text area

4. **Configure Import**:
   - Dashboard name: Quantum Harvest Control (P2.7)
   - Folder: Select or leave as "General"
   - Datasource: Select "Prometheus" from dropdown
   - Click "Import"

5. **Verify**:
   - Dashboard should load with 7 panels
   - Check that kill scores are displaying (BTCUSDT, ETHUSDT, SOLUSDT)
   - Verify 10s auto-refresh is active

---

### Method 2: Via SSH + API (Advanced)

**On local machine**:
```powershell
# Copy dashboard to VPS (already done)
# File location: /tmp/quantum_harvest_control_p27.json
```

**On VPS** (SSH into server):
```bash
# SSH into VPS
wsl ssh -i ~/.ssh/hetzner_fresh root@46.224.116.254

# Get Prometheus datasource UID
curl -s -u admin:QuantumTrader2024! http://localhost:3001/api/datasources | \
  python3 -c "import sys,json; ds=[d for d in json.load(sys.stdin) if d['type']=='prometheus']; print(ds[0]['uid'])"
# Output example: "PBFA97CFB590B2093" (your UID will differ)

# Save the UID
PROM_UID="<paste-UID-here>"

# Update dashboard JSON
python3 << EOF
import json
with open('/tmp/quantum_harvest_control_p27.json') as f:
    dashboard = json.load(f)

def update_datasource(obj):
    if isinstance(obj, dict):
        for k, v in obj.items():
            if k == 'datasource' and isinstance(v, dict):
                if '\${DS_PROMETHEUS}' in str(v.get('uid', '')):
                    v['uid'] = '$PROM_UID'
            else:
                update_datasource(v)
    elif isinstance(obj, list):
        for item in obj:
            update_datasource(item)

update_datasource(dashboard)

with open('/tmp/dashboard_final.json', 'w') as f:
    json.dump({'dashboard': dashboard, 'overwrite': True}, f, indent=2)
print("Dashboard prepared for import")
EOF

# Import to Grafana
curl -X POST -u admin:QuantumTrader2024! \
  -H 'Content-Type: application/json' \
  -d @/tmp/dashboard_final.json \
  http://localhost:3001/api/dashboards/db

# Expected output: {"status":"success", "url":"/d/<uid>/quantum-harvest-control-p27", ...}
```

---

## Dashboard Overview

### Panel Layout

**Row 1: Overview (3 panels)**
- **Kill Score Gauge**: Shows current kill scores for all 3 symbols
  - ðŸŸ¢ Green: 0.0 - 0.59 (safe)
  - ðŸ”´ Red: 0.60+ (edge collapse warning)
- **R_net Stat**: Net risk-reward ratio
  - ðŸŸ¢ Green: >=7 (excellent)
  - ðŸŸ¡ Yellow: 3-6.9 (acceptable)
  - ðŸ”´ Red: <3 (poor)
- **New SL Stat**: Proposed new stop loss values

**Row 2: Kill Components (3 panels, one per symbol)**
- Stacked area charts showing component breakdown:
  - Regime Flip (2.0x weight)
  - Sigma Spike (1.5x weight)
  - TS Drop (2.5x weight)
  - Age Penalty (0.5x weight)

**Row 3: Actions Summary (1 panel)**
- Table with columns:
  - Symbol, Kill Score, R_net, New SL, Regime Flip, TS Drop
- Kill Score column has conditional background color

### PromQL Queries Used

```promql
# Kill Score
quantum_harvest_kill_score

# Components
quantum_harvest_k_regime_flip{symbol="BTCUSDT"}
quantum_harvest_k_sigma_spike{symbol="BTCUSDT"}
quantum_harvest_k_ts_drop{symbol="BTCUSDT"}
quantum_harvest_k_age_penalty{symbol="BTCUSDT"}

# Risk-Reward
quantum_harvest_r_net

# Stop Loss
quantum_harvest_new_sl

# Action (one-hot)
quantum_harvest_action{symbol="BTCUSDT",action="FULL_CLOSE_PROPOSED"}
```

---

## Verification Checklist

After import, verify:
- [ ] Dashboard loads without errors
- [ ] 7 panels are visible (3 in row 1, 3 in row 2, 1 in row 3)
- [ ] Kill score gauges show values (0-1 range)
- [ ] Component charts display stacked areas
- [ ] Table shows data for all 3 symbols
- [ ] Auto-refresh is set to 10s
- [ ] Time range selector works (default: Last 6 hours)
- [ ] No "No Data" or "Panel Error" messages

---

## Troubleshooting

### Dashboard Shows "No Data"
1. **Check Prometheus datasource**:
   - Grafana â†’ Configuration â†’ Data Sources
   - Verify "Prometheus" exists and URL is correct (http://localhost:9091)
2. **Test Prometheus query**:
   ```bash
   curl -s "http://localhost:9091/api/v1/query?query=quantum_harvest_kill_score"
   ```
3. **Check exporter service**:
   ```bash
   systemctl status quantum-harvest-metrics-exporter
   curl http://127.0.0.1:8042/metrics
   ```

### Panel Shows "Panel Error"
- Edit panel â†’ Check query syntax
- Verify metric name spelling: `quantum_harvest_*`
- Check datasource selection (should be "Prometheus")

### Wrong Datasource UID
- Dashboard JSON has placeholder `${DS_PROMETHEUS}`
- Must be replaced with actual UID during import
- Use Method 2 (API) to programmatically update UID

---

## Access Information

**Grafana**:
- URL: http://46.224.116.254:3001
- Username: admin
- Password: QuantumTrader2024!

**Prometheus**:
- URL: http://46.224.116.254:9091
- Targets: http://localhost:9091/targets (check harvest-exporter)
- Query: http://localhost:9091/graph

**Metrics Exporter**:
- Endpoint: http://46.224.116.254:8042/metrics
- Health: http://46.224.116.254:8042/health
- Service: quantum-harvest-metrics-exporter.service

---

## Next Steps After Import

1. **Set Dashboard as Favorite**:
   - Click star icon (top right) to bookmark dashboard
2. **Create Alerts** (optional):
   - Edit Kill Score panel
   - Add alert rule: kill_score >= 0.6
   - Configure notification channel
3. **Adjust Time Range**:
   - Default: Last 6 hours
   - Change to "Last 24 hours" for longer view
4. **Create Snapshots**:
   - Share â†’ Snapshot â†’ Create snapshot
   - Useful for documentation or bug reports

---

**Import Time**: ~5 minutes  
**Dashboard Name**: Quantum Harvest Control (P2.7)  
**Metrics Source**: quantum-harvest-exporter (port 8042)  
**Refresh Rate**: 10s
