services:
  backend:
    build:
      context: .
      dockerfile: backend/Dockerfile
    container_name: quantum_backend
    restart: unless-stopped
    profiles: ["dev"]
    env_file:
      - .env
    environment:
      # SÃ¸rg for at Python finner backend/ som modul
      - PYTHONPATH=/app/backend
      - GO_LIVE=true
      - QT_ADMIN_TOKEN=${QT_ADMIN_TOKEN:-dev-admin}
      
      # ğŸ” BINANCE TESTNET API CREDENTIALS
      - BINANCE_API_KEY=IsY3mFpko7Z8joZr8clWwpJZuZcFdAtnDBy4g4ULQu827Gf6kJPAPS9VyVOVrR0r
      - BINANCE_API_SECRET=tEKYWf77tqSOArfgeSqgVwiO62bjro8D1VMaEvXBwcUOQuRxmCdxrtTvAXy7ZKSE
      - BINANCE_TESTNET=true
      - BINANCE_USE_TESTNET=true
      - EXCHANGE_MODE=binance_testnet
      - BYBIT_ENABLED=false
      
      # ğŸ¤– AI MODEL SELECTION (NEW!)
      - AI_MODEL=hybrid                    # ğŸš€ HYBRID: TFT (60%) + XGBoost (40%) ensemble
                                            # Options: xgb (fast), tft (temporal), hybrid (best)
      
      # ğŸ§  AI HEDGE FUND OS BRAINS (PHASE 2 INTEGRATION)
      - ENABLE_BRAINS=true                 # âœ… Activate CEO, Strategy, Risk Brains
      - CEO_MODE=ACTIVE                    # CEO Brain operating mode control
      
      # ğŸ¯ SIGNAL QUALITY SETTINGS (RAISED FOR BETTER TRADES - 2025-12-08)
      - QT_EVENT_DRIVEN_MODE=true
      - QT_CONFIDENCE_THRESHOLD=0.70    # RAISED: Only strong consensus signals (was 0.45)
      - QT_SIGNAL_QUEUE_MAX=20          # REDUCED: Keep only best 20 signals (was 100)
      - QT_CHECK_INTERVAL=10            # Check every 10 seconds
      - QT_COOLDOWN_SECONDS=120         # Longer cooldown for quality
      - LOG_LEVEL=DEBUG
      - QT_LOG_LEVEL=DEBUG
      
      # ğŸ”§ ORCHESTRATOR POLICY CONFIDENCE THRESHOLDS (LOWERED FOR MORE TRADES)
      - QT_POLICY_MIN_CONF_TRENDING=0.18    # 18% for trending (was 32%)
      - QT_POLICY_MIN_CONF_RANGING=0.22     # 22% for ranging (was 40%)
      - QT_POLICY_MIN_CONF_NORMAL=0.20      # 20% for normal (was 38%)
      
      # Enable trading and AI
      - QT_EXECUTION_EXCHANGE=binance-futures
      - QT_MARKET_TYPE=usdm_perp
      - QT_PAPER_TRADING=true          # Paper trading on mainnet symbols
      
      # ğŸ’° AI-DRIVEN POSITION SIZING ($14K BALANCE)
      - RM_MAX_POSITION_USD=2000        # Max $2,000 margin (14% of $14K for 7+ positions)
      - RM_MIN_POSITION_USD=100         # Min $100 margin
      - RM_MAX_LEVERAGE=30.0            # 30x leverage (safer for multiple positions)
      
      # ğŸš€ RL V3 LIVE ORCHESTRATOR (PRODUCTION MODE)
      - RL_V3_MODE=PRIMARY              # PRIMARY: Active trading, SHADOW: Metrics only
      - RM_RISK_PER_TRADE_PCT=0.10      # 10% base risk per trade (was 2%)
      - RM_MIN_RISK_PCT=0.01            # 1% minimum risk
      - RM_MAX_RISK_PCT=0.05            # 5% maximum risk per position
      - RM_MAX_EXPOSURE_PCT=2.00        # 200% max total exposure (with leverage)
      - RM_HIGH_CONF_MULT=1.5          # 1.5x size for confidence >= 0.85
      - RM_LOW_CONF_MULT=0.5           # 0.5x size for confidence < 0.60
      - RM_SIGNAL_QUALITY_ADJ=true     # Enable AI confidence-based scaling
      - RM_MAX_CONCURRENT_TRADES=20    # Max 20 concurrent positions (testnet: more for AI training)
      - RM_MAX_DAILY_DD_PCT=0.15        # 15% max daily drawdown (increased for testnet)
      - RM_MAX_WEEKLY_DD_PCT=0.25       # 25% max weekly drawdown
      - STAGING_MODE=false              # ğŸ”¥ REAL ORDERS - STOP_LOSS guaranteed execution
      - QT_ENABLE_EXECUTION=true       # âœ… Execution enabled (paper mode)
      - QT_ENABLE_AI_TRADING=true      # âœ… AI trading enabled
      - QT_MIN_CONFIDENCE=0.65         # 65%+ trained ML + AI re-evaluation safety
      - QT_EXECUTION_MIN_NOTIONAL=20.0
      - QT_QUOTES=USDT                 # Use USDT (not USDC) for testnet compatibility
      - DEFAULT_QUOTE=USDT              # Universe selection uses USDT pairs
      
      # ğŸ¯ DYNAMIC UNIVERSE SELECTION: Layer1 + Layer2 + Megacap sorted by 24h volume
      # Use QT_UNIVERSE instead of hardcoded QT_SYMBOLS for better diversification
      - QT_UNIVERSE=l1l2-top           # "l1l2-top" = Layer1/Layer2 coins by volume
                    # "megacap" = Only top 20-30 major coins
                    # "all-usdt" = All available USDT pairs
      - QT_MAX_SYMBOLS=100              # Max symbols to trade (top 100 by volume)
      # QT_SYMBOLS not set - using dynamic universe instead
      
      # ğŸ¯ LEVERAGE & POSITION SIZING: Now using .env values (30x leverage, 4 positions)
      # All QT_DEFAULT_LEVERAGE, QT_MAX_POSITIONS, QT_MAX_NOTIONAL_PER_TRADE are read from .env
      
      # ğŸ’° TAKE PROFIT / STOP LOSS: Use Exit Policy Engine (ATR-based) instead of AI Dynamic TP/SL
      # QT_TP_PCT, QT_SL_PCT, QT_TRAIL_PCT, QT_PARTIAL_TP all from .env
      - QT_USE_AI_DYNAMIC_TPSL=true  # âœ… ENABLE AI Dynamic TP/SL - volatility and confidence-based exits
      - QT_FORCE_EXITS_ENABLED=true  # Aktiver forced exits
      
      # ğŸ›‘ MODEL SUPERVISOR: Bias detection and model performance tracking
      - QT_MODEL_SUPERVISOR_MODE=ENFORCED          # ENFORCED=block biased trades, OBSERVE=log only
      - QT_MODEL_SUPERVISOR_BIAS_THRESHOLD=0.70    # Block if >70% SHORT or LONG bias
      - QT_MODEL_SUPERVISOR_MIN_SAMPLES=20         # Need 20 signals to detect bias
      
      # ğŸ² RL POSITION SIZING: Increased exploration for aggressive sizing
      - RL_SIZING_EPSILON=0.50                     # 50% exploration (was 10%)
      - RL_SIZING_ALPHA=0.15                       # Learning rate
      - RL_SIZING_DISCOUNT=0.95                    # Discount factor
      
      # ğŸš€ RL V3 ACTIVATION - Advanced reinforcement learning position sizing
      - QT_RL_V3_ENABLED=true                      # Enable RL v3 PPO agent
      - QT_RL_V3_SHADOW_MODE=false                 # Disable shadow mode = LIVE TRADING with RL v3!
      - QT_RL_V3_TRAINING_ENABLED=true             # Enable live training
      - QT_RL_V3_CHECKPOINT_DIR=/app/models/rl_v3  # Model checkpoint directory
      - QT_RL_V3_UPDATE_INTERVAL=10                # âš¡ Update policy every 10 steps (was 100)
      
      # ğŸ§  EXIT BRAIN V3: Unified TP/SL/Trailing orchestrator
      - EXIT_BRAIN_V3_ENABLED=true                 # âœ… ENABLED: Exit Brain v3 active (unified TP/SL orchestration)
      
      # âœ… ALLOWED SYMBOLS: 50 USDT Futures pairs (top volume) for autonomous trading
      - QT_ALLOWED_SYMBOLS=BTCUSDT,ETHUSDT,SOLUSDT,ZECUSDT,ALPACAUSDT,XRPUSDT,DOGEUSDT,BNBUSDT,ASTERUSDT,HYPEUSDT,RESOLVUSDT,XANUSDT,BNXUSDT,FILUSDT,ICPUSDT,XPLUSDT,ZENUSDT,AVAXUSDT,ALPHAUSDT,UNIUSDT,1000PEPEUSDT,PUMPUSDT,STRKUSDT,BCHUSDT,METUSDT,DASHUSDT,SOONUSDT,NEARUSDT,TAOUSDT,PAXGUSDT,BEATUSDT,PIEVERSEUSDT,AAVEUSDT,JCTUSDT,GIGGLEUSDT,FETUSDT,TRUMPUSDT,TRXUSDT,WLFIUSDT,UXLINKUSDT,VIDTUSDT,DUSKUSDT,AGIXUSDT,WIFUSDT,PENGUUSDT,ADAUSDT,LINKUSDT,DOTUSDT,MATICUSDT,LTCUSDT
      
      # ğŸ¤– CONTINUOUS LEARNING: Autotraining based on live trade outcomes
      - QT_CONTINUOUS_LEARNING=true         # Enable continuous learning
      - QT_MIN_SAMPLES_FOR_RETRAIN=50       # Retrain after 50 new samples
      - QT_RETRAIN_INTERVAL_HOURS=24        # Auto-retrain every 24 hours
      - QT_AUTO_BACKTEST_AFTER_TRAIN=true   # Run backtest after each retrain
      
      # ğŸ“ CLM (Continuous Learning Manager) - Central ML/AI orchestrator
      - QT_CLM_ENABLED=true                 # âœ… ACTIVATE CLM for XGBoost/LightGBM/N-HiTS/PatchTST
      - QT_CLM_RETRAIN_HOURS=0.5            # âš¡ AGGRESSIVE: Retrain every 30 minutes (was 168h = 7 days)
      - QT_CLM_DRIFT_HOURS=0.25             # âš¡ Check drift every 15 minutes (was 24h)
      - QT_CLM_PERF_HOURS=0.17              # âš¡ Check performance every 10 minutes (was 6h)
      - QT_CLM_DRIFT_THRESHOLD=0.05         # Trigger retraining if drift score > 0.05
      - QT_CLM_SHADOW_MIN=100               # Min 100 predictions before shadow promotion
      - QT_CLM_AUTO_RETRAIN=true            # Auto-trigger retraining on drift/performance
      - QT_CLM_AUTO_PROMOTE=true            # Auto-promote shadow models if better
      
      # ğŸ” AI MONITORING & MANAGEMENT: Model Supervisor, Portfolio Balancer
      - QT_MODEL_SUPERVISOR_INTERVAL=300    # Check AI bias every 5 min
      - QT_BIAS_THRESHOLD=0.65              # Alert if >65% short or long bias
      - QT_PORTFOLIO_BALANCER_INTERVAL=60   # Balance portfolio every 1 min
      - QT_MAX_CORRELATION=0.7              # Max 0.7 correlation between positions
      
      - QT_MIN_SAMPLES_FOR_RETRAIN=50       # Retrain after 50 new samples
      - QT_RETRAIN_INTERVAL_HOURS=24        # Auto-retrain every 24 hours
      - QT_AUTO_BACKTEST_AFTER_TRAIN=true   # Run backtest after each retrain
      
      # Force some trades for data collection
      - QT_FORCE_SAMPLE_COLLECTION=true
    ports:
      - "8000:8000"
    volumes:
      # Mount backend-koden inn i containeren uten Ã¥ endre pakkenavnet
      - ./backend:/app/backend
      # Mount AI engine
      - ./ai_engine:/app/ai_engine
      # Mount models
      - ./models:/app/models
      # Mount database-filer
      - ./database:/app/database
    dns:
      - 8.8.8.8
      - 8.8.4.4
    networks:
      - quantum_trader
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8000/health', timeout=10)"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  backend-live:
    build:
      context: .
      dockerfile: backend/Dockerfile
    container_name: quantum_backend_live
    restart: unless-stopped
    profiles: ["live"]
    env_file:
      - ./backend/.env.live
    environment:
      - PYTHONPATH=/app/backend
      - GO_LIVE=true
      # Hardening: limit workers to 1 so APScheduler runs once
      - UVICORN_WORKERS=1
    # Use Dockerfile's default CMD (uvicorn backend.main:app)
    healthcheck:
      test: ["CMD", "python3", "-c", "import requests; requests.get('http://localhost:8000/health')"]
      interval: 30s
      timeout: 5s
      retries: 5
    ports:
      - "8000:8000"
    volumes:
      - ./backend:/app/backend
      - ./database:/app/database
    networks:
      - quantum_trader

  # Strategy Generator AI - Continuous Evolution
  strategy_generator:
    build:
      context: .
      dockerfile: backend/research/Dockerfile.strategy_generator
    container_name: quantum_strategy_generator
    restart: unless-stopped
    profiles: ["strategy-gen"]
    env_file:
      - .env
    environment:
      - PYTHONPATH=/app/backend
      - LOG_LEVEL=INFO
      # Strategy generation config
      - GENERATION_INTERVAL_HOURS=24     # Run new generation every 24 hours
      - POPULATION_SIZE=20               # 20 strategies per generation
      - MUTATION_RATE=0.3                # 30% mutation rate
      - CROSSOVER_RATE=0.4               # 40% crossover rate
    volumes:
      - ./backend:/app/backend
      - ./ai_engine:/app/ai_engine
      - ./backend/data:/app/backend/data  # Persist database
    networks:
      - quantum_trader

  # Shadow Testing & Deployment Service
  shadow_tester:
    build:
      context: .
      dockerfile: backend/research/Dockerfile.strategy_generator
    container_name: quantum_shadow_tester
    restart: unless-stopped
    profiles: ["strategy-gen"]
    env_file:
      - .env
    environment:
      - PYTHONPATH=/app/backend
      - LOG_LEVEL=INFO
      # Shadow testing config
      - SHADOW_INTERVAL_MINUTES=15       # Test every 15 minutes
      - DEPLOYMENT_INTERVAL_HOURS=1      # Check deployments every hour
    command: ["python", "-m", "backend.research.shadow_runner"]
    volumes:
      - ./backend:/app/backend
      - ./ai_engine:/app/ai_engine
      - ./backend/data:/app/backend/data  # Persist database
    networks:
      - quantum_trader
    depends_on:
      - strategy_generator

  # Prometheus Metrics Service
  metrics:
    build:
      context: .
      dockerfile: backend/research/Dockerfile.strategy_generator
    container_name: quantum_metrics
    restart: unless-stopped
    profiles: ["strategy-gen"]
    env_file:
      - .env
    environment:
      - PYTHONPATH=/app/backend
      - LOG_LEVEL=INFO
      - METRICS_PORT=9090
      - METRICS_UPDATE_INTERVAL=60
    command: ["python", "-m", "backend.research.metrics_server"]
    ports:
      - "9090:9090"
    volumes:
      - ./backend:/app/backend
      - ./ai_engine:/app/ai_engine
      - ./backend/data:/app/backend/data
    networks:
      - quantum_trader

  testnet:
    build:
      context: .
      dockerfile: Dockerfile.testnet
    container_name: quantum_testnet
    restart: unless-stopped
    profiles: ["testnet"]
    env_file:
      - .env
    environment:
      - PYTHONPATH=/app/backend
      - LOG_LEVEL=INFO
    volumes:
      - ./scripts:/app/scripts
      - ./ai_engine:/app/ai_engine
      - ./config:/app/config
      - ./logs:/app/logs
      - ./models:/app/models
      - .env:/app/.env
    networks:
      - quantum_trader

  # Dashboard V3.0 - Next.js Frontend (EPIC: DASHBOARD-V3-001)
  frontend:
    image: node:20-alpine
    container_name: quantum_frontend_v3
    restart: unless-stopped
    profiles: ["dev"]
    working_dir: /app
    command: sh -c "npm install && npm run dev"
    ports:
      - "3000:3000"
    volumes:
      - ./frontend:/app
      - /app/node_modules
      - /app/.next
    environment:
      - NODE_ENV=development
      - NEXT_PUBLIC_API_URL=http://localhost:8000
      - NEXT_PUBLIC_WS_URL=ws://localhost:8000
    networks:
      - quantum_trader
    depends_on:
      - backend
  
  # Legacy UI (qt-agent-ui) - Keep for reference
  frontend-legacy:
    image: node:20-alpine
    container_name: quantum_frontend_legacy
    restart: unless-stopped
    profiles: ["legacy-ui"]
    working_dir: /app
    command: sh -c "npm install && npm run dev -- --host 0.0.0.0"
    ports:
      - "5173:5173"
    volumes:
      - ./qt-agent-ui:/app
      - /app/node_modules
    environment:
      - VITE_API_URL=http://localhost:8000
    networks:
      - quantum_trader
    depends_on:
      - backend

  # Redis - Architecture v2 EventBus & PolicyStore Backend
  redis:
    image: redis:7-alpine
    container_name: quantum_redis
    restart: unless-stopped
    profiles: ["dev", "live", "testnet", "microservices"]
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    command: redis-server --appendonly yes --appendfsync everysec
    networks:
      - quantum_trader
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 3s
      retries: 3

  # ========================================================================
  # SPRINT 2: MICROSERVICES ARCHITECTURE (7 Services)
  # ========================================================================
  
  # Service #1: Risk & Safety Management (PolicyStore + ESS)
  risk-safety:
    build:
      context: .
      dockerfile: microservices/risk_safety/Dockerfile
    container_name: quantum_risk_safety
    restart: unless-stopped
    profiles: ["microservices"]
    env_file:
      - .env
    environment:
      - PYTHONPATH=/app/backend
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - PORT=8005
    ports:
      - "8005:8005"
    volumes:
      - ./microservices/risk_safety:/app/microservices/risk_safety
      - ./backend:/app/backend
      - ./logs:/app/logs
      - ./data:/app/data
    networks:
      - quantum_trader
    depends_on:
      redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8005/health', timeout=5)"]
      interval: 30s
      timeout: 5s
      retries: 3

  # Service #2: Execution & Position Monitoring
  execution:
    build:
      context: .
      dockerfile: microservices/execution/Dockerfile
    container_name: quantum_execution
    restart: unless-stopped
    profiles: ["microservices"]
    env_file:
      - .env
    environment:
      - PYTHONPATH=/app/backend
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - RISK_SAFETY_SERVICE_URL=http://risk-safety:8003
      - USE_BINANCE_TESTNET=true
      - EXECUTION_MODE=${EXECUTION_MODE:-TESTNET}
      - BINANCE_API_KEY=${BINANCE_API_KEY}
      - BINANCE_API_SECRET=${BINANCE_API_SECRET}
    ports:
      - "8002:8002"
    volumes:
      - ./microservices/execution:/app/microservices/execution
      - ./backend:/app/backend  # Temporary: Copy backend modules until fully extracted
      - ./logs:/app/logs
      - ./data:/app/data
    networks:
      - quantum_trader
    depends_on:
      redis:
        condition: service_healthy
      risk-safety:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "python", "-c", "import requests; requests.get('http://localhost:8002/health')"]
      interval: 30s
      timeout: 5s
      retries: 3

  # Service #2b: CLM v3 - Continuous Learning Manager
  clm:
    build:
      context: .
      dockerfile: microservices/clm/Dockerfile
    container_name: quantum_clm
    restart: unless-stopped
    profiles: ["microservices"]
    env_file:
      - .env
    environment:
      - PYTHONPATH=/app
      - REDIS_URL=redis://redis:6379
      - MODELS_DIR=/app/models
      - CLM_METADATA_DIR=/app/data/clm_v3/registry
      - QT_CLM_RETRAIN_HOURS=${QT_CLM_RETRAIN_HOURS:-0.5}
      - QT_CLM_DRIFT_HOURS=${QT_CLM_DRIFT_HOURS:-0.25}
      - QT_CLM_PERF_HOURS=${QT_CLM_PERF_HOURS:-0.17}
    volumes:
      - ./models:/app/models
      - ./data:/app/data
      - ./backend:/app/backend
      - ./ai_engine:/app/ai_engine
      - ./microservices/clm:/app/microservices/clm
    networks:
      - quantum_trader
    depends_on:
      redis:
        condition: service_healthy

  # Service #3: Portfolio Intelligence (Aggregator + PnL + Exposure)
  portfolio-intelligence:
    build:
      context: .
      dockerfile: microservices/portfolio_intelligence/Dockerfile
    container_name: quantum_portfolio_intelligence
    restart: unless-stopped
    profiles: ["microservices", "dev"]
    env_file:
      - .env
    environment:
      - PYTHONPATH=/app/backend
      
      # ğŸ” BINANCE TESTNET API CREDENTIALS (with PORTFOLIO_ prefix for Pydantic)
      - PORTFOLIO_BINANCE_API_KEY=IsY3mFpko7Z8joZr8clWwpJZuZcFdAtnDBy4g4ULQu827Gf6kJPAPS9VyVOVrR0r
      - PORTFOLIO_BINANCE_API_SECRET=tEKYWf77tqSOArfgeSqgVwiO62bjro8D1VMaEvXBwcUOQuRxmCdxrtTvAXy7ZKSE
      - PORTFOLIO_USE_TESTNET=true
      
      # Also set without prefix as fallback
      - BINANCE_API_KEY=IsY3mFpko7Z8joZr8clWwpJZuZcFdAtnDBy4g4ULQu827Gf6kJPAPS9VyVOVrR0r
      - BINANCE_API_SECRET=tEKYWf77tqSOArfgeSqgVwiO62bjro8D1VMaEvXBwcUOQuRxmCdxrtTvAXy7ZKSE
      - BINANCE_TESTNET=true
      - USE_TESTNET=true
      
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - REDIS_URL=redis://redis:6379
      - PORTFOLIO_REDIS_HOST=redis
      - RISK_SAFETY_SERVICE_URL=http://risk-safety:8003
      - TRADE_STORE_TYPE=sqlite
      - TRADE_STORE_DB_PATH=/app/data/trades.db
    ports:
      - "8004:8004"
    volumes:
      - ./microservices/portfolio_intelligence:/app/microservices/portfolio_intelligence
      - ./backend:/app/backend  # Shared backend modules
      - ./logs:/app/logs
      - ./data:/app/data
    networks:
      - quantum_trader
    depends_on:
      redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8004/health', timeout=5)"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 60s

  # Service #4: AI Engine (Ensemble + Meta-Strategy + RL Sizing)
  ai-engine:
    build:
      context: .
      dockerfile: microservices/ai_engine/Dockerfile
    container_name: quantum_ai_engine
    restart: unless-stopped
    profiles: ["microservices"]
    env_file:
      - .env
    environment:
      - PYTHONPATH=/app/backend
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - RISK_SAFETY_SERVICE_URL=http://risk-safety:8003
      - AI_ENGINE_MIN_SIGNAL_CONFIDENCE=0.65
      - AI_ENGINE_ENSEMBLE_MODELS=["xgb","lgbm","nhits","patchtst"]
      # ğŸ“ Continuous Learning & Retraining (Aggressive Schedule)
      - AI_ENGINE_CONTINUOUS_LEARNING_ENABLED=true
      - AI_ENGINE_MIN_SAMPLES_FOR_RETRAIN=20   # Retrain after 20 trades
      - AI_ENGINE_RETRAIN_INTERVAL_HOURS=2     # Auto-retrain every 2 hours
    ports:
      - "8001:8001"
    volumes:
      - ./microservices/ai_engine:/app/microservices/ai_engine
      - ./backend:/app/backend  # Shared backend modules
      - ./ai_engine:/app/ai_engine  # AI models and agents
      - ./models:/app/models  # Model files
      - ./logs:/app/logs
      - ./data:/app/data
    networks:
      - quantum_trader
    depends_on:
      redis:
        condition: service_healthy
      risk-safety:
        condition: service_healthy
      market-publisher:
        condition: service_started
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8001/health', timeout=5)"]
      interval: 30s
      timeout: 5s
      retries: 3

  # Service #7: Governance Dashboard (Phase 4H)
  governance-dashboard:
    build:
      context: .
      dockerfile: backend/microservices/governance_dashboard/Dockerfile
    container_name: quantum_governance_dashboard
    restart: unless-stopped
    profiles: ["microservices"]
    environment:
      - REDIS_HOST=redis
      - REDIS_PORT=6379
    ports:
      - "8501:8501"
    volumes:
      - ./logs:/app/logs  # Mount logs for validation log access
    networks:
      - quantum_trader
    depends_on:
      redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8501/health', timeout=5)"]
      interval: 30s
      timeout: 5s
      retries: 3

  governance-alerts:
    build:
      context: .
      dockerfile: backend/microservices/governance_alerts/Dockerfile
    container_name: quantum_governance_alerts
    restart: unless-stopped
    profiles: ["microservices"]
    environment:
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      # Email alerts configuration (optional)
      - ALERT_EMAIL=${ALERT_EMAIL:-}
      - EMAIL_USER=${EMAIL_USER:-}
      - EMAIL_PASS=${EMAIL_PASS:-}
      - SMTP_SERVER=${SMTP_SERVER:-smtp.gmail.com}
      - SMTP_PORT=${SMTP_PORT:-587}
      # Telegram alerts configuration (optional)
      - TELEGRAM_TOKEN=${TELEGRAM_TOKEN:-}
      - TELEGRAM_CHAT_ID=${TELEGRAM_CHAT_ID:-}
      # Alert thresholds
      - CPU_THRESHOLD=${CPU_THRESHOLD:-85}
      - MEM_THRESHOLD=${MEM_THRESHOLD:-80}
      - MAPE_THRESHOLD=${MAPE_THRESHOLD:-0.06}
      - SHARPE_THRESHOLD=${SHARPE_THRESHOLD:-0.8}
    volumes:
      - ./logs:/app/logs  # Mount logs for validation log access
    networks:
      - quantum_trader
    depends_on:
      redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "python", "-c", "import psutil; exit(0)"]
      interval: 30s
      timeout: 5s
      retries: 3

  auto-executor:
    build:
      context: .
      dockerfile: backend/microservices/auto_executor/Dockerfile
    container_name: quantum_auto_executor
    restart: unless-stopped
    profiles: ["microservices"]
    environment:
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      # Exchange configuration
      - EXCHANGE=${EXCHANGE:-binance}
      - TESTNET=${TESTNET:-true}
      - PAPER_TRADING=${PAPER_TRADING:-true}
      # Binance API credentials (use testnet keys first!)
      - BINANCE_API_KEY=${BINANCE_API_KEY:-}
      - BINANCE_API_SECRET=${BINANCE_API_SECRET:-}
      # Risk management settings
      - MAX_RISK_PER_TRADE=${MAX_RISK_PER_TRADE:-0.01}
      - MAX_LEVERAGE=${MAX_LEVERAGE:-3}
      - MAX_POSITION_SIZE=${MAX_POSITION_SIZE:-1000}
      - CONFIDENCE_THRESHOLD=${CONFIDENCE_THRESHOLD:-0.55}
      - MAX_DRAWDOWN=${MAX_DRAWDOWN:-4.0}
    networks:
      - quantum_trader
    depends_on:
      redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "python", "-c", "import redis; r=redis.Redis(host='redis'); exit(0 if r.ping() else 1)"]
      interval: 30s
      timeout: 5s
      retries: 3

  # Service #8: Trade Journal & Performance Analytics (Phase 7)
  trade-journal:
    build:
      context: .
      dockerfile: backend/microservices/trade_journal/Dockerfile
    container_name: quantum_trade_journal
    restart: unless-stopped
    profiles: ["microservices"]
    environment:
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      # Performance analytics configuration
      - REPORT_INTERVAL_HOURS=${REPORT_INTERVAL_HOURS:-6}
      - MAX_TRADES=${MAX_TRADES:-1000}
      - STARTING_EQUITY=${STARTING_EQUITY:-100000}
    volumes:
      - ./backend/microservices/trade_journal/reports:/app/reports
    networks:
      - quantum_trader
    depends_on:
      redis:
        condition: service_healthy
      auto-executor:
        condition: service_started
    healthcheck:
      test: ["CMD", "python", "-c", "import redis; r=redis.Redis(host='redis'); exit(0 if r.ping() else 1)"]
      interval: 30s
      timeout: 5s
      retries: 3

  # Service #9: Reinforcement Learning Optimizer (Phase 8)
  rl-optimizer:
    build:
      context: .
      dockerfile: backend/microservices/rl_optimizer/Dockerfile
    container_name: quantum_rl_optimizer
    restart: unless-stopped
    profiles: ["microservices"]
    environment:
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      # RL Hyperparameters
      - RL_ALPHA=${RL_ALPHA:-0.3}
      - RL_GAMMA=${RL_GAMMA:-0.95}
      - RL_EPSILON=${RL_EPSILON:-0.1}
      - RL_UPDATE_INTERVAL=${RL_UPDATE_INTERVAL:-1800}
      # Reward weights
      - REWARD_PNL_WEIGHT=${REWARD_PNL_WEIGHT:-0.7}
      - REWARD_SHARPE_WEIGHT=${REWARD_SHARPE_WEIGHT:-0.25}
      - REWARD_DRAWDOWN_WEIGHT=${REWARD_DRAWDOWN_WEIGHT:-0.05}
      # Safety constraints
      - MIN_WEIGHT=${MIN_WEIGHT:-0.05}
      - MAX_WEIGHT=${MAX_WEIGHT:-0.60}
    networks:
      - quantum_trader
    depends_on:
      redis:
        condition: service_healthy
      trade-journal:
        condition: service_started
    healthcheck:
      test: ["CMD", "python", "-c", "import redis; r=redis.Redis(host='redis'); exit(0 if r.ping() else 1)"]
      interval: 30s
      timeout: 5s
      retries: 3

  # Service #10: Meta-Cognitive Strategy Evaluator (Phase 9)
  strategy-evaluator:
    build:
      context: .
      dockerfile: backend/microservices/strategy_evaluator/Dockerfile
    container_name: quantum_strategy_evaluator
    restart: unless-stopped
    profiles: ["microservices"]
    environment:
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      # Strategy evaluation configuration
      - EVALUATION_INTERVAL=${EVALUATION_INTERVAL:-43200}  # 12 hours
      - NUM_VARIANTS=${NUM_VARIANTS:-5}
      - MUTATION_RANGE=${MUTATION_RANGE:-0.2}  # Â±20%
    volumes:
      - ./backend/microservices/strategy_evaluator/sandbox_strategies:/app/sandbox_strategies
    networks:
      - quantum_trader
    depends_on:
      redis:
        condition: service_healthy
      rl-optimizer:
        condition: service_started
      trade-journal:
        condition: service_started
    healthcheck:
      test: ["CMD", "python", "-c", "import redis; r=redis.Redis(host='redis'); exit(0 if r.ping() else 1)"]
      interval: 30s
      timeout: 5s
      retries: 3

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # ğŸ§¬ PHASE 10: AUTONOMOUS STRATEGY EVOLUTION & LONG-TERM MEMORY
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # Evolutionary memory subsystem:
  # - Collects all meta_best_strategy from Phase 9
  # - Evaluates performance over days and weeks
  # - Computes fitness scores based on PnL, Sharpe, survival time
  # - Performs natural selection - keeps top 3 survivors
  # - Mutates and combines top strategies via genetic crossover
  # - Stores archive of all strategies in /memory_bank/
  # Creates an ecosystem where strategies compete and only the fittest survive
  strategy-evolution:
    build:
      context: ./backend/microservices/strategy_evolution
      dockerfile: Dockerfile
    container_name: quantum_strategy_evolution
    restart: unless-stopped
    profiles: ["microservices"]
    environment:
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      # Evolution configuration
      - EVOLUTION_INTERVAL=${EVOLUTION_INTERVAL:-86400}  # 24 hours (daily evolution)
      - SURVIVORS=${SURVIVORS:-3}  # Keep top 3 strategies
      - MAX_MEMORY=${MAX_MEMORY:-100}  # Maximum 100 strategies in memory
      - CROSSOVER_RATE=${CROSSOVER_RATE:-0.7}  # 70% crossover probability
    volumes:
      - ./backend/microservices/strategy_evolution/memory_bank:/app/memory_bank
    networks:
      - quantum_trader
    depends_on:
      redis:
        condition: service_healthy
      strategy-evaluator:
        condition: service_started
      rl-optimizer:
        condition: service_started
      trade-journal:
        condition: service_started
    healthcheck:
      test: ["CMD", "python", "-c", "import redis; r=redis.Redis(host='redis'); exit(0 if r.ping() else 1)"]
      interval: 30s
      timeout: 5s
      retries: 3

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # ğŸ§  PHASE 11: QUANTUM POLICY MEMORY & TEMPORAL REGIME FORECASTING
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # Quantum Policy Memory Layer:
  # - Reads Phase 10's long-term memory (all strategies, results, patterns)
  # - Trains Temporal Fusion Transformer (TFT) to predict:
  #   * Future regime (bull, bear, volatile, neutral)
  #   * Policy behavior (when to increase/reduce risk)
  # - Writes predictions to Governance Layer for automatic adjustments
  # - Extends ensemble with meta-forecaster agent
  quantum-policy-memory:
    build:
      context: ./backend/microservices/quantum_policy_memory
      dockerfile: Dockerfile
    container_name: quantum_policy_memory
    restart: unless-stopped
    profiles: ["microservices"]
    environment:
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      # Quantum Policy Memory configuration
      - FORECAST_INTERVAL=${FORECAST_INTERVAL:-21600}  # 6 hours
      - MIN_SAMPLES=${MIN_SAMPLES:-50}  # Minimum samples needed
      - SEQUENCE_LENGTH=${SEQUENCE_LENGTH:-32}  # Time steps
      - TRAINING_EPOCHS=${TRAINING_EPOCHS:-5}  # Training epochs
    volumes:
      - ./backend/microservices/strategy_evolution/memory_bank:/app/policy_memory
    networks:
      - quantum_trader
    depends_on:
      redis:
        condition: service_healthy
      strategy-evolution:
        condition: service_started
    healthcheck:
      test: ["CMD", "python", "-c", "import redis, torch; r=redis.Redis(host='redis'); exit(0 if r.ping() else 1)"]
      interval: 30s
      timeout: 10s
      retries: 3

  federation-stub:
    build:
      context: ./backend/microservices/federation_stub
      dockerfile: Dockerfile
    container_name: quantum_federation_stub
    restart: unless-stopped
    profiles: ["microservices"]
    environment:
      - REDIS_HOST=redis
    volumes:
      - ./backend/microservices/federation_stub/federation_stub_log:/app/federation_stub_log
    networks:
      - quantum_trader
    depends_on:
      quantum-policy-memory:
        condition: service_started
    healthcheck:
      test: ["CMD", "python", "-c", "import redis; r=redis.Redis(host='redis'); r.ping()"]
      interval: 60s
      timeout: 10s
      retries: 3

  market-publisher:
    build:
      context: .
      dockerfile: backend/Dockerfile
    container_name: quantum_market_publisher
    restart: unless-stopped
    profiles: ["microservices"]
    command: python3 /app/simple_market_publisher.py
    environment:
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - REDIS_DB=0
      - PYTHONPATH=/app
      # Market data symbols to track
      - MARKET_SYMBOLS=BTCUSDT,ETHUSDT,BNBUSDT,SOLUSDT,AVAXUSDT,ADAUSDT,DOTUSDT,LINKUSDT,MATICUSDT,LTCUSDT
    volumes:
      - ./simple_market_publisher.py:/app/simple_market_publisher.py
    networks:
      - quantum_trader
    depends_on:
      redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "python3", "-c", "import redis; r=redis.Redis(host='redis'); exit(0 if r.ping() else 1)"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  # ğŸ“Š QUANTUM TRADER DASHBOARD V4 - AI Hedge Fund Metrics
  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  
  dashboard-backend:
    build:
      context: ./dashboard_v4/backend
      dockerfile: Dockerfile
    container_name: quantum_dashboard_backend
    restart: unless-stopped
    profiles: ["dashboard", "prod"]
    environment:
      - DATABASE_URL=postgresql+psycopg2://postgres:postgres@postgres:5432/quantumdb
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - REDIS_DB=0
      - PYTHONPATH=/app
    ports:
      - "8025:8000"
    networks:
      - quantum_trader
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8000/health', timeout=5)"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 5s

  dashboard-frontend:
    build:
      context: ./dashboard_v4/frontend
      dockerfile: Dockerfile
    container_name: quantum_dashboard_frontend
    restart: unless-stopped
    profiles: ["dashboard", "prod"]
    ports:
      - "8889:80"
    networks:
      - quantum_trader
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost/"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 5s

networks:
  quantum_trader:
    driver: bridge

volumes:
  redis_data:
    driver: local
