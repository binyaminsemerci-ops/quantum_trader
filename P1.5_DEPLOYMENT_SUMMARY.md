# P1.5 Risk Proposal Publisher — Deployment Summary

**Implemented**: 2026-01-22  
**Status**: ✅ READY FOR VPS DEPLOYMENT  
**Type**: CALC-ONLY (no trading side-effects)

---

## What Was Built

**P1.5 Risk Proposal Publisher** - systemd service that reads MarketState + positions, computes risk proposals, publishes to Redis (NO trading)

### Files Created

1. **`microservices/risk_proposal_publisher/main.py`** (380 lines)
   - `PositionSourceAdapter` - auto-detect positions from Redis
   - `RiskProposalPublisher` - main service logic
   - Rate limiting, error handling, --once mode

2. **`deployment/systemd/quantum-risk-proposal.service`**
   - systemd unit file
   - User: qt, RestartSec=10, MemoryMax=512M

3. **`deployment/config/risk-proposal.env`**
   - Environment configuration
   - SYMBOLS, PUBLISH_INTERVAL_SEC, POSITION_SOURCE

4. **`ops/deploy_risk_proposal_publisher.sh`**
   - One-command deployment script
   - Copies config, service file, enables and starts

5. **`P1.5_RISK_PROPOSAL_PUBLISHER.md`** (comprehensive documentation)

6. **`P1B_VPS_PROOF_PACK_COMPLETE.md`** (P1 VPS verification results)

---

## Architecture Flow

```
P0.5 MarketState (quantum-marketstate.service)
  → quantum:marketstate:<SYMBOL>
     ↓ reads
P1.5 Risk Proposal Publisher (quantum-risk-proposal.service)
  + Position Source (auto-detect: redis → stream → synthetic)
  + P1 Risk Kernel (compute_proposal)
     ↓ publishes
Redis Outputs (read-only)
  → quantum:risk:proposal:<SYMBOL> (hash)
  → quantum:stream:risk.proposal (optional stream)
```

---

## Key Features

**1. Calc-Only Design**
- ✅ NO TradeIntents
- ✅ NO execution API calls
- ✅ NO orders/modify/close
- ✅ Read-only from Redis
- ✅ Publish proposals only

**2. Auto-Detect Position Source**
- Try `quantum:state:positions` (hash)
- Fallback to `quantum:stream:execution.result` (parse)
- Fallback to synthetic (testing)

**3. Rate Limiting**
- Publish only if SL/TP changed >0.1%
- OR >60 seconds elapsed since last publish
- Avoids Redis spam

**4. Graceful Error Handling**
- Per-symbol error isolation
- Service auto-restart on crash
- Detailed logging to journald

**5. Debug Mode**
- `--once` flag for single cycle
- `--position-source synthetic` for testing
- No need for real positions to verify

---

## Redis Data Contracts

### Input: MarketState (from P0.5)
```redis
HGETALL quantum:marketstate:BTCUSDT
```
Fields: sigma, mu, ts, p_trend, p_mr, p_chop, dp, vr, spike_proxy

### Input: Positions (auto-detect)
- `quantum:state:positions:<SYMBOL>` (hash)
- `quantum:state:positions` (hash with JSON values)
- `quantum:stream:execution.result` (POSITION_OPENED events)
- Synthetic fallback

### Output: Risk Proposals
```redis
HGETALL quantum:risk:proposal:BTCUSDT
```
Fields: proposed_sl, proposed_tp, stop_dist_pct, tp_dist_pct, trail_gap_pct, reason_codes, ts, sigma, p_trend, p_mr, p_chop, computed_at_utc, position_side, position_age_sec

---

## VPS Deployment Commands

### Quick Deploy
```bash
# On VPS
ssh -i ~/.ssh/hetzner_fresh root@46.224.116.254
cd /home/qt/quantum_trader
git pull origin main
bash ops/deploy_risk_proposal_publisher.sh
```

### Verification Commands
```bash
# 1. Service status
sudo systemctl status quantum-risk-proposal

# 2. View logs
sudo journalctl -u quantum-risk-proposal -n 80 --no-pager

# 3. Check Redis proposals
redis-cli HGETALL quantum:risk:proposal:BTCUSDT
redis-cli HGETALL quantum:risk:proposal:ETHUSDT
redis-cli HGETALL quantum:risk:proposal:SOLUSDT

# 4. Debug mode (single cycle)
cd /home/qt/quantum_trader
source /opt/quantum/venvs/ai-engine/bin/activate
python3 microservices/risk_proposal_publisher/main.py --once

# 5. Test with synthetic positions
python3 microservices/risk_proposal_publisher/main.py --once --position-source synthetic
```

---

## Expected Logs

```
Jan 22 22:45:00 [INFO] RiskProposalPublisher initialized
Jan 22 22:45:00 [INFO]   Symbols: ['BTCUSDT', 'ETHUSDT', 'SOLUSDT']
Jan 22 22:45:00 [INFO]   Interval: 10s
Jan 22 22:45:00 [INFO]   Position source: auto
Jan 22 22:45:00 [INFO] Starting publish loop
Jan 22 22:45:00 [INFO] === Risk Proposal Publish Cycle ===
Jan 22 22:45:00 [INFO] Published proposal for BTCUSDT: SL=$115.7875 TP=$119.5293 reasons=trail_active,sl_tightening
Jan 22 22:45:00 [INFO] Published proposal for ETHUSDT: SL=$101.8217 TP=$103.6398 reasons=trail_active,regime_mr
Jan 22 22:45:00 [DEBUG] SOLUSDT: No position found, skipping
```

---

## PASS/FAIL Criteria for VPS Proof Pack

### ✅ PASS if:
1. Service starts and shows `Active: active (running)`
2. Logs show publish cycles every 10 seconds
3. Redis has `quantum:risk:proposal:<SYMBOL>` keys with valid data
4. `--once` mode works (single cycle, then exit)
5. `--position-source synthetic` works (no real positions needed)
6. No trading imports (grep confirms)
7. Service auto-restarts on crash

### ❌ FAIL if:
1. Service crashes and won't restart
2. No proposals in Redis after 60 seconds
3. Errors about missing dependencies
4. Imports from execution/trading modules
5. --once mode hangs or crashes

---

## Configuration

**Default Settings** (`/etc/quantum/risk-proposal.env`):
```bash
REDIS_URL=redis://localhost:6379
SYMBOLS=BTCUSDT,ETHUSDT,SOLUSDT
PUBLISH_INTERVAL_SEC=10
POSITION_SOURCE=auto
ENABLE_STREAM=false
```

**Recommended for Testing**:
```bash
POSITION_SOURCE=synthetic  # Use synthetic positions
ENABLE_STREAM=true         # Publish to stream for time-series
```

**Recommended for Production**:
```bash
POSITION_SOURCE=auto       # Auto-detect real positions
ENABLE_STREAM=false        # Hash only (unless Grafana needs stream)
```

---

## Integration Points

**Upstream Dependencies**:
- ✅ P0.5 quantum-marketstate.service (must be running)
- ✅ Redis (localhost:6379)
- ✅ Python venv (/opt/quantum/venvs/ai-engine)

**Downstream Consumers** (future):
- Grafana dashboards (read quantum:risk:proposal:*)
- Risk manager services
- Exit monitor (could consume proposals)
- Trading decision layer (P3+)

**Current State**: Standalone publisher, no downstream consumers yet (proposals available for inspection/dashboards)

---

## Next Steps After P1.5 Deployment

### Immediate (P1.5 VPS Proof Pack)
1. Deploy to VPS: `bash ops/deploy_risk_proposal_publisher.sh`
2. Verify service running
3. Check Redis proposals
4. Test --once mode
5. Document results

### Next Phase (P2)
**P2 Harvesting Proposal Engine** (calc-only):
- Partial exit logic (lock profits at milestones)
- Risk-adjusted harvest timing
- Uses P0.5 MarketState + P1 proposals
- Publishes to `quantum:harvest:proposal:<symbol>`

**P2.5 Harvesting Publisher** (systemd):
- Similar to P1.5 but for harvest proposals
- Same pattern: read → compute → publish (NO execution)

### Future (P3+)
- P3 Sizer/Leverage Module
- Apply Layer (actual MODIFY/CLOSE under gates)

---

## Compliance Summary

| Requirement | Status |
|-------------|--------|
| Calc-only (NO trading) | ✅ PASS |
| systemd-only (no Docker) | ✅ PASS |
| Auto-detect positions | ✅ PASS |
| Rate limiting | ✅ PASS |
| Error handling | ✅ PASS |
| --once debug mode | ✅ PASS |
| Synthetic fallback | ✅ PASS |
| Redis read-only | ✅ PASS |
| Publish proposals only | ✅ PASS |
| Full audit trail | ✅ PASS |

---

## Documentation Files

- **P1.5_RISK_PROPOSAL_PUBLISHER.md** - Full specification and usage
- **P1B_VPS_PROOF_PACK_COMPLETE.md** - P1 VPS verification results
- **P1_RISK_KERNEL_COMPLETE.md** - P1 core module documentation
- **P0_P05_COMPLETION_CHECKLIST.md** - P0/P0.5 verification
- **This file** - Deployment summary

---

## Conclusion

**P1.5 Risk Proposal Publisher**: ✅ **READY FOR VPS DEPLOYMENT**

- All files created and committed (commit bfedcf9a)
- Deployment script ready: `ops/deploy_risk_proposal_publisher.sh`
- Documentation complete
- Calc-only design verified (no trading imports)
- Auto-detect position source (robust fallback chain)
- Rate limiting and error handling in place

**Next**: Deploy to VPS and run proof pack verification.
