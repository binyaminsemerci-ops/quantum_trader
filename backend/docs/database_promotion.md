# Database Promotion Procedure

This runbook documents when and how Alembic schema migrations are promoted to
staging and production. Follow these steps alongside the deployment runbook in
`backend/README.md` for every release that includes database changes.

## Release cadence

- **Staging**: Tuesdays at 14:00 UTC after the application smoke-tests finish.
- **Production**: Thursdays at 14:00 UTC, provided staging has remained healthy
  for at least 24 hours and no incidents are open.
- **Emergency fixes**: May be scheduled ad-hoc, but always complete the dry-run
  and change-approval steps before touching production.

## Preflight checklist

1. Ensure the release branch is frozen (tagged) and the migration history is
   linear (`alembic history --verbose`).
2. Capture a fresh SQLite backup from the target environment (for production,
   pull the latest offsite snapshot).
3. Verify the migration renders clean SQL without applying it:

   ```pwsh
   python backend/scripts/alembic_dry_run.py `
       --snapshot backups/staging/trades-2025-11-06.db `
       --sql-output artifacts/alembic-upgrade-staging.sql
   ```

   Review the generated SQL and attach it to the change ticket.

4. Run the online dry-run to ensure the migration succeeds on the snapshot copy
   (the script above performs this as part of the same execution).
5. Document findings and approvals in the release tracker.

## Staging execution

1. Export staging secrets and `DATABASE_URL`.
2. Apply the migration: `alembic upgrade head`.
3. Run `python -m pytest backend/tests` against the staging deployment and
   execute the smoke workflow (API health, scheduler, `/risk`).
4. Leave the staging release under observation for a minimum of 24 hours.

## Production execution

1. Re-run the dry-run script using the production snapshot to refresh the SQL
   artifact and confirm the migration still applies cleanly.
2. Present the SQL output to the change board and receive approval.
3. Apply the migration during the scheduled window:

   ```pwsh
   setx DATABASE_URL "<production-connection-string>"
   alembic upgrade head
   ```

4. Immediately run the production smoke checklist (health endpoints, trade log
   writer, scheduler loop) and monitor for 30 minutes.
5. File the change-completion notes with links to the dry-run artifact, approval
   evidence, and monitoring snapshots.

## Rollback strategy

- For SQLite snapshots, rollback is performed by restoring the most recent
  pre-change backup and redeploying the prior release tag.
- If a migration is partially applied, use the SQL generated by
  `alembic downgrade -1 --sql` to validate the undo steps before executing a
  rollback.
- Always keep the dry-run SQL artifacts for both upgrade and downgrade with the
  change ticket to accelerate approvals during incident response.
