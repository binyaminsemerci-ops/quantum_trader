import os
import shutil
import warnings

import pytest

from fastapi.testclient import TestClient


# Suppress noisy third-party DeprecationWarnings from websockets during tests
warnings.filterwarnings(
    "ignore",
    category=DeprecationWarning,
    module="websockets",
)
warnings.filterwarnings(
    "ignore",
    category=DeprecationWarning,
    module="binance.ws.websocket_api",
)
warnings.filterwarnings(
    "ignore",
    category=DeprecationWarning,
    module="websockets.legacy",
)

# Ensure admin-protected endpoints are gated during tests
os.environ.setdefault("QT_ADMIN_TOKEN", "test-admin-token")


@pytest.fixture
def audit_log_file(tmp_path, monkeypatch):
    from backend.utils.audit import reset_admin_audit_logger  # type: ignore

    log_path = tmp_path / "admin_audit.log"
    monkeypatch.setenv("QT_ADMIN_AUDIT_PATH", str(log_path))
    reset_admin_audit_logger()
    yield log_path
    reset_admin_audit_logger()


@pytest.fixture
def test_db_file(tmp_path):
    # Create a temporary directory for the test DB per-test
    tmpdir = tmp_path / "test_db"
    tmpdir.mkdir()
    db_path = tmpdir / "test_trades.db"
    db_url = f"sqlite:///{db_path}"

    # Export env var so backend.database picks it up
    os.environ["QUANTUM_TRADER_DATABASE_URL"] = db_url
    risk_state_path = tmpdir / "risk_state.db"
    os.environ["QT_RISK_STATE_DB"] = str(risk_state_path)

    yield str(db_path)

    # Cleanup
    try:
        shutil.rmtree(str(tmpdir))
    except Exception as e:
        import logging

        logging.getLogger(__name__).debug("failed to remove tmp test dir: %s", e)


@pytest.fixture
def client(test_db_file):
    # Import here so that backend.database reads the env var we set above
    from backend.main import app
    from backend.database import Base, engine

    # Create all tables for the test
    Base.metadata.create_all(bind=engine)

    with TestClient(app) as c:
        yield c
        # Drop all tables after test for clean DB
        Base.metadata.drop_all(bind=engine)
