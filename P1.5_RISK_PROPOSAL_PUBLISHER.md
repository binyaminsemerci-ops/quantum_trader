# P1.5 Risk Proposal Publisher

**Status**: ✅ IMPLEMENTATION COMPLETE  
**Date**: 2026-01-22  
**Type**: CALC-ONLY SERVICE (no trading side-effects)

---

## Overview

P1.5 Risk Proposal Publisher is a systemd service that:
1. **Reads** MarketState metrics from Redis (published by P0.5 quantum-marketstate)
2. **Reads** position snapshots (auto-detect from Redis or synthetic fallback)
3. **Computes** risk proposals using P1 Risk Kernel
4. **Publishes** proposals to Redis (hash + optional stream)

**NO TradeIntents, NO execution calls, NO orders, NO modify/close.**

---

## Architecture

```
┌─────────────────────────────────────────────────────────────┐
│ P0.5 MarketState Publisher (quantum-marketstate.service)   │
│ └─> Redis: quantum:marketstate:<SYMBOL>                    │
└─────────────────────────────────────────────────────────────┘
                            ↓ reads
┌─────────────────────────────────────────────────────────────┐
│ Position Source (auto-detect)                              │
│ 1. quantum:state:positions (hash/json)                     │
│ 2. quantum:stream:execution.result (parse latest)          │
│ 3. Synthetic fallback (testing)                            │
└─────────────────────────────────────────────────────────────┘
                            ↓ reads
┌─────────────────────────────────────────────────────────────┐
│ P1.5 Risk Proposal Publisher (quantum-risk-proposal.service)│
│ └─> Calls: compute_proposal(market_state, position)       │
└─────────────────────────────────────────────────────────────┘
                            ↓ publishes
┌─────────────────────────────────────────────────────────────┐
│ Redis Outputs (read-only for dashboards/audit)            │
│ • Hash: quantum:risk:proposal:<SYMBOL>                     │
│ • Stream: quantum:stream:risk.proposal (optional)          │
└─────────────────────────────────────────────────────────────┘
```

---

## Implementation

### Files Created

**1. Service Module**: `microservices/risk_proposal_publisher/main.py` (380 lines)

**Key Classes**:
- `PositionSourceAdapter` - Auto-detect and fetch positions from Redis
- `RiskProposalPublisher` - Main publisher service

**Features**:
- Auto-detect position source (redis_hash → redis_stream → synthetic)
- Rate limiting (publish only if changed >0.1% or >60s elapsed)
- Graceful error handling per symbol
- `--once` mode for debugging
- Full audit trail in published data

**2. Systemd Service**: `deployment/systemd/quantum-risk-proposal.service`

**Configuration**:
- User: qt
- WorkingDirectory: /home/qt/quantum_trader
- Restart: always (RestartSec=10)
- Resource limits: MemoryMax=512M, CPUQuota=50%

**3. Environment Config**: `deployment/config/risk-proposal.env`

**Settings**:
```bash
REDIS_URL=redis://localhost:6379
SYMBOLS=BTCUSDT,ETHUSDT,SOLUSDT
PUBLISH_INTERVAL_SEC=10
POSITION_SOURCE=auto  # auto | redis_hash | redis_stream | synthetic
ENABLE_STREAM=false   # true to publish to stream
```

**4. Deployment Script**: `ops/deploy_risk_proposal_publisher.sh`

---

## Redis Data Contracts

### Input: MarketState (from P0.5)

**Key**: `quantum:marketstate:<SYMBOL>`  
**Type**: Hash

```redis
HGETALL quantum:marketstate:BTCUSDT
```

**Fields**:
- sigma (float) - volatility
- mu (float) - trend
- ts (float) - trend strength
- p_trend, p_mr, p_chop (floats) - regime probabilities
- dp, vr, spike_proxy (floats) - features
- ts_timestamp (ISO8601) - last update

### Input: Positions (auto-detect)

**Option 1**: `quantum:state:positions:<SYMBOL>` (hash)
```redis
HGETALL quantum:state:positions:BTCUSDT
```

**Option 2**: `quantum:state:positions` (hash with JSON values)
```redis
HGET quantum:state:positions BTCUSDT
```

**Option 3**: `quantum:stream:execution.result` (parse POSITION_OPENED events)

**Option 4**: Synthetic (fallback for testing)

**Required Fields**:
- symbol, side, entry_price, current_price
- peak_price, trough_price, age_sec, unrealized_pnl
- current_sl, current_tp (optional)

### Output: Risk Proposals

**Key**: `quantum:risk:proposal:<SYMBOL>`  
**Type**: Hash

```redis
HGETALL quantum:risk:proposal:BTCUSDT
```

**Fields**:
```json
{
  "proposed_sl": "115.7875",
  "proposed_tp": "119.5293",
  "stop_dist_pct": "0.0199",
  "tp_dist_pct": "0.0394",
  "trail_gap_pct": "0.0187",
  "reason_codes": "trail_active,sl_tightening,regime_trend,tp_extended",
  "ts": "0.6000",
  "sigma": "0.015000",
  "p_trend": "0.7",
  "p_mr": "0.1",
  "p_chop": "0.2",
  "computed_at_utc": "2026-01-22T22:45:00.123456",
  "position_side": "LONG",
  "position_age_sec": "1200.0",
  "position_current_price": "115.0",
  "position_entry_price": "100.0"
}
```

**Optional Stream**: `quantum:stream:risk.proposal` (XADD with same fields + symbol)

---

## Deployment

### Prerequisites
- ✅ P0.5 quantum-marketstate.service running
- ✅ Redis accessible on localhost:6379
- ✅ Python venv at /opt/quantum/venvs/ai-engine
- ✅ User: qt with proper permissions

### Deploy to VPS

```bash
# On VPS
cd /home/qt/quantum_trader
git pull origin main

# Run deployment script
bash ops/deploy_risk_proposal_publisher.sh
```

**What it does**:
1. Copies config to `/etc/quantum/risk-proposal.env`
2. Copies service to `/etc/systemd/system/quantum-risk-proposal.service`
3. Reloads systemd daemon
4. Enables and starts service
5. Shows status

### Manual Deployment Steps

```bash
# 1. Copy config
sudo cp deployment/config/risk-proposal.env /etc/quantum/
sudo chown qt:qt /etc/quantum/risk-proposal.env
sudo chmod 640 /etc/quantum/risk-proposal.env

# 2. Copy service
sudo cp deployment/systemd/quantum-risk-proposal.service /etc/systemd/system/
sudo chmod 644 /etc/systemd/system/quantum-risk-proposal.service

# 3. Reload and start
sudo systemctl daemon-reload
sudo systemctl enable quantum-risk-proposal.service
sudo systemctl start quantum-risk-proposal.service

# 4. Check status
sudo systemctl status quantum-risk-proposal
```

---

## Verification Commands

### 1. Check Service Status
```bash
sudo systemctl status quantum-risk-proposal
```

**Expected**: `Active: active (running)`

### 2. View Recent Logs
```bash
sudo journalctl -u quantum-risk-proposal -n 80 --no-pager
```

**Expected Output**:
```
Jan 22 22:45:00 [INFO] RiskProposalPublisher initialized
Jan 22 22:45:00 [INFO]   Symbols: ['BTCUSDT', 'ETHUSDT', 'SOLUSDT']
Jan 22 22:45:00 [INFO]   Interval: 10s
Jan 22 22:45:00 [INFO]   Position source: auto
Jan 22 22:45:00 [INFO] Starting publish loop
Jan 22 22:45:00 [INFO] === Risk Proposal Publish Cycle ===
Jan 22 22:45:00 [INFO] Published proposal for BTCUSDT: SL=$115.7875 TP=$119.5293 reasons=trail_active,sl_tightening
```

### 3. Check Redis Proposals
```bash
redis-cli HGETALL quantum:risk:proposal:BTCUSDT
redis-cli HGETALL quantum:risk:proposal:ETHUSDT
redis-cli HGETALL quantum:risk:proposal:SOLUSDT
```

**Expected**: Hash with proposed_sl, proposed_tp, reason_codes, etc.

### 4. Test Single Cycle (Debug Mode)
```bash
cd /home/qt/quantum_trader
source /opt/quantum/venvs/ai-engine/bin/activate
python3 microservices/risk_proposal_publisher/main.py --once
```

**Expected**: Single cycle runs, publishes to Redis, exits

### 5. Test with Synthetic Positions
```bash
python3 microservices/risk_proposal_publisher/main.py --once --position-source synthetic
```

**Expected**: Uses synthetic positions, publishes proposals

---

## Configuration Options

### Environment Variables

| Variable | Default | Description |
|----------|---------|-------------|
| REDIS_URL | redis://localhost:6379 | Redis connection string |
| SYMBOLS | BTCUSDT,ETHUSDT,SOLUSDT | Comma-separated symbol list |
| PUBLISH_INTERVAL_SEC | 10 | Seconds between publish cycles |
| POSITION_SOURCE | auto | auto \| redis_hash \| redis_stream \| synthetic |
| ENABLE_STREAM | false | Publish to quantum:stream:risk.proposal |

### Position Source Modes

**auto** (recommended):
- Try `quantum:state:positions` hash
- Fallback to `quantum:stream:execution.result`
- Fallback to synthetic

**redis_hash**:
- Only read from `quantum:state:positions` or `quantum:state:positions:<SYMBOL>`

**redis_stream**:
- Only parse `quantum:stream:execution.result` for POSITION_OPENED events

**synthetic**:
- Generate test positions (for testing without real positions)

---

## Rate Limiting

Publisher uses intelligent rate limiting to avoid spam:

**Publish if**:
1. SL changed by >0.1%, OR
2. TP changed by >0.1%, OR
3. >60 seconds elapsed since last publish

**Otherwise**: Skip publish (log at DEBUG level)

---

## Error Handling

**Per-symbol graceful degradation**:
- If MarketState missing for BTCUSDT → Skip BTCUSDT, continue with ETHUSDT/SOLUSDT
- If position missing → Skip symbol (log at DEBUG)
- If proposal computation fails → Log error, continue with next symbol

**Service restart**:
- `Restart=always` with `RestartSec=10`
- `StartLimitBurst=5` (max 5 restarts in 5 minutes)

---

## Integration with Dashboards

### Grafana Query Examples

**Query 1: Latest SL/TP Proposals**
```redis
HGET quantum:risk:proposal:BTCUSDT proposed_sl
HGET quantum:risk:proposal:BTCUSDT proposed_tp
```

**Query 2: Proposal Reason Codes**
```redis
HGET quantum:risk:proposal:BTCUSDT reason_codes
```

**Query 3: Time-series (if ENABLE_STREAM=true)**
```redis
XREVRANGE quantum:stream:risk.proposal + - COUNT 100
```

### Example Dashboard Panel

**Metric**: Risk Proposal SL/TP  
**Query**: `quantum:risk:proposal:<symbol>`  
**Fields**: proposed_sl, proposed_tp, stop_dist_pct, reason_codes  
**Refresh**: 10s

---

## Troubleshooting

### Service Won't Start

**Check logs**:
```bash
sudo journalctl -u quantum-risk-proposal -n 100 --no-pager
```

**Common issues**:
1. Redis not running: `sudo systemctl start redis`
2. Venv missing: Check `/opt/quantum/venvs/ai-engine`
3. Permission issue: Check user `qt` owns `/home/qt/quantum_trader`

### No Proposals in Redis

**Debug with --once**:
```bash
cd /home/qt/quantum_trader
source /opt/quantum/venvs/ai-engine/bin/activate
python3 microservices/risk_proposal_publisher/main.py --once --position-source synthetic
```

**Check if**:
1. P0.5 quantum-marketstate is publishing: `redis-cli HGETALL quantum:marketstate:BTCUSDT`
2. Positions exist or use synthetic mode
3. Service is running: `sudo systemctl status quantum-risk-proposal`

### Proposals Not Updating

**Check rate limiting**:
- Proposals only update if SL/TP changed >0.1% or >60s elapsed
- View DEBUG logs: Edit `/etc/quantum/risk-proposal.env` → `LOG_LEVEL=DEBUG` → restart service

---

## Next Steps

### P1.5 Complete ✅
- ✅ Reads MarketState from P0.5
- ✅ Auto-detects position source
- ✅ Computes proposals using P1
- ✅ Publishes to Redis (calc-only)
- ✅ systemd service ready
- ✅ Deployment script ready

### What's Next

**After VPS Proof Pack**:

1. **P2 Harvesting Proposal Engine** (calc-only)
   - Partial exit logic
   - Profit locking strategies
   - Risk-adjusted harvest timing

2. **P2.5 Harvesting Publisher** (systemd)
   - Similar to P1.5 but for harvest proposals
   - Publish to `quantum:harvest:proposal:<symbol>`

3. **P3 Sizer/Leverage Module** (calc-only)
   - Position size recommendations
   - Leverage adjustments based on risk

4. **Apply Layer** (execution integration)
   - Consume proposals from P1.5/P2.5/P3
   - Apply under safety gates
   - Actual MODIFY/CLOSE calls (gated)

---

## Compliance Checklist

- ✅ Calc-only (no trading imports verified)
- ✅ NO TradeIntents
- ✅ NO execution API calls
- ✅ NO orders/modify/close
- ✅ Read-only from Redis
- ✅ Publish proposals only
- ✅ systemd-only (no Docker)
- ✅ Graceful error handling
- ✅ Rate limiting
- ✅ Full audit trail
- ✅ --once mode for debugging
- ✅ Auto-detect position source
- ✅ Synthetic fallback

---

## Conclusion

**P1.5 Risk Proposal Publisher**: ✅ **READY FOR DEPLOYMENT**

- Systemd service configured
- Auto-detects position sources
- Publishes calc-only proposals
- No trading side-effects
- Full integration with P0.5 and P1

Ready to deploy and verify on VPS with proof pack.
