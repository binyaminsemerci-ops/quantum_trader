name: CI Metrics Logging

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

jobs:
  test-and-log:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      
    - name: Set up Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '20'
        
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: Install frontend dependencies
      working-directory: ./frontend
      run: npm ci
      
    - name: Run frontend tests
      id: frontend_tests
      working-directory: ./frontend
      run: |
        npm test -- --ci --coverage --maxWorkers=2 || echo "FRONTEND_FAILED=true" >> $GITHUB_ENV
        
    - name: Install backend dependencies
      working-directory: ./quantumfond_backend
      run: |
        pip install -r requirements.txt
        pip install pytest pytest-cov
        
    - name: Run backend tests
      id: backend_tests
      working-directory: ./quantumfond_backend
      run: |
        pytest tests/ --cov=app --cov-report=term || echo "BACKEND_FAILED=true" >> $GITHUB_ENV
        
    - name: Log CI metrics to VPS
      if: always()
      env:
        SSH_KEY: ${{ secrets.HETZNER_SSH_KEY }}
        VPS_HOST: ${{ secrets.VPS_HOST || '46.224.116.254' }}
      run: |
        # Calculate build duration
        START_TIME=${{ github.event.head_commit.timestamp }}
        END_TIME=$(date -u +%s)
        DURATION=$((END_TIME - START_TIME))
        
        # Determine build status
        if [ "$FRONTEND_FAILED" == "true" ] || [ "$BACKEND_FAILED" == "true" ]; then
          BUILD_STATUS="failure"
          EXIT_CODE=1
        else
          BUILD_STATUS="success"
          EXIT_CODE=0
        fi
        
        # Count test failures (approximate from logs)
        FRONTEND_FAILURES=$(grep -c "FAIL" frontend/test-results.txt 2>/dev/null || echo 0)
        BACKEND_FAILURES=$(grep -c "FAILED" backend/test-results.txt 2>/dev/null || echo 0)
        TOTAL_FAILURES=$((FRONTEND_FAILURES + BACKEND_FAILURES))
        
        # Prepare SSH
        mkdir -p ~/.ssh
        echo "$SSH_KEY" > ~/.ssh/hetzner_key
        chmod 600 ~/.ssh/hetzner_key
        
        # Log CI status
        ssh -i ~/.ssh/hetzner_key -o StrictHostKeyChecking=no root@$VPS_HOST << EOF
          mkdir -p /home/qt/quantum_trader/monitoring/logs
          echo "$(date -u +%s),$BUILD_STATUS,$DURATION" >> /home/qt/quantum_trader/monitoring/logs/ci_status.log
          echo "$(date -u +%s),github-actions,$TOTAL_FAILURES" >> /home/qt/quantum_trader/monitoring/logs/ci_tests.log
          
          # Also log to error log if failures detected
          if [ $TOTAL_FAILURES -gt 0 ]; then
            echo "$(date -u +'%Y-%m-%d %H:%M:%S') [ERROR] CI Build ${{ github.run_id }} failed with $TOTAL_FAILURES test failures" >> /home/qt/quantum_trader/monitoring/logs/errors.log
          fi
        EOF
        
    - name: Notify Slack on failure
      if: failure()
      env:
        SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK_CI }}
      run: |
        curl -X POST $SLACK_WEBHOOK \
          -H 'Content-Type: application/json' \
          -d '{
            "text": "‚ùå CI Build Failed",
            "attachments": [{
              "color": "danger",
              "fields": [
                {"title": "Repository", "value": "${{ github.repository }}", "short": true},
                {"title": "Branch", "value": "${{ github.ref_name }}", "short": true},
                {"title": "Commit", "value": "${{ github.sha }}", "short": true},
                {"title": "Author", "value": "${{ github.actor }}", "short": true}
              ]
            }]
          }'
