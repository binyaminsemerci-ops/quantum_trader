# Systemd Stabilization Notes - 2026-01-07

## Overview
Successfully stabilized Quantum Trader systemd deployment on production VPS 46.224.116.254.

**Final State:**
- 0 failed units (was 1)
- 0 activating loops (was 5)
- 12 services running stable
- All fixes applied at OS level (no code changes)

---

## Golden Snapshot

**Location:** `/root/unit_backups_clean_20260107_final/`  
**Contents:** 20 files (84K total)
- 19 quantum-*.service unit files
- 1 quantum-trader.target

**Purpose:** Known-good state for rollback/reference

**Restore Command:**
```bash
cd /home/qt/quantum_trader
./ops/systemd/restore_units_from_snapshot.sh
```

---

## Fixes Applied

### Fix 1: Removed Stale AI-Engine References
**Issue:** `systemctl --failed` showed `quantum-ai-engine.service not-found failed`

**Root Cause:**
- Unit file never existed or was removed
- References remained in:
  - `quantum-trader.target` → `Wants=quantum-ai-engine.service`
  - `quantum-clm.service` → `After=quantum-ai-engine.service`

**Solution:**
```bash
sed -i "/^Wants=quantum-ai-engine\.service$/d" /etc/systemd/system/quantum-trader.target
sed -i "s/ quantum-ai-engine\.service//" /etc/systemd/system/quantum-clm.service
systemctl daemon-reload
systemctl reset-failed
```

**Verification:**
```bash
grep -RIn "quantum-ai-engine\.service" /etc/systemd/system
# Result: OK, no references
```

---

### Fix 2: Portfolio-Intelligence Redis Hostname Resolution
**Issue:** Service restart loop with error:
```
redis.exceptions.ConnectionError: Error -3 connecting to quantum_redis:6379
socket.gaierror: Temporary failure in name resolution
```

**Root Cause:**
- Python code uses Docker hostname `quantum_redis`
- Systemd deployment has no Docker DNS
- Environment file has `REDIS_HOST=127.0.0.1` but code also uses hardcoded hostname

**Solution (OS-Level):**
```bash
echo "127.0.0.1 quantum_redis" >> /etc/hosts
```

**Verification:**
```bash
getent hosts quantum_redis
# Result: 127.0.0.1 quantum_redis ✅

systemctl is-active quantum-portfolio-intelligence.service
# Result: active ✅
```

**⚠️ Persistence Note:**
- `/etc/hosts` changes NOT persistent across cloud-init/rebuilds
- **Action Required:** Add to cloud-init user-data
- See RUNBOOK_SYSTEMD.md for cloud-init snippet

---

### Fix 3: Write Permission Fixes (Earlier)

#### quantum-execution.service
**Issue:** EventBus DiskBuffer permission denied  
**Fix:** Added `ReadWritePaths=/home/qt/quantum_trader/runtime`

#### quantum-rl-monitor.service
**Issue:** CSV log write permission denied  
**Fix:**
- Changed `WorkingDirectory` to `/home/qt/quantum_trader`
- Added `ReadWritePaths=/var/log`

#### quantum-portfolio-intelligence.service
**Issue:** Log file write permission denied  
**Fix:** Added `ReadWritePaths=/home/qt/quantum_trader/logs /home/qt/quantum_trader/runtime`

---

## Source Documentation

Detailed documentation exists in `/root/`:

### /root/OPS_STATE_2026-01-07_systemd_clean.md
- Current health verification
- Key fixes summary
- Golden snapshot location
- Quick verification commands

### /root/OPS_FIX_2026-01-07_portfolio-intelligence_hosts-alias.md
- Symptom description
- Root cause analysis
- Fix procedure (OS-level /etc/hosts)
- Verification steps

---

## Disabled Services (Future Work)

### quantum-clm.service
**Status:** Disabled  
**Issue:** Tries to write to `/app/models` (read-only filesystem)  
**Fix Needed:** Code change to use `/data/quantum/models`

### quantum-risk-safety.service
**Status:** Disabled  
**Issue:** `ModuleNotFoundError: No module named 'microservices'`  
**Fix Needed:** Add `Environment="PYTHONPATH=/home/qt/quantum_trader"` to unit file

---

## Not-Found Units (Expected)

13 services in quantum-trader.target Wants= but no unit files exist yet:
- quantum-cross-exchange
- quantum-exposure-balancer
- quantum-meta-regime
- quantum-model-federation
- quantum-model-supervisor
- quantum-pil
- quantum-portfolio-governance
- quantum-retraining-worker
- quantum-rl-dashboard
- quantum-strategic-evolution
- quantum-strategic-memory
- quantum-trade-intent-consumer
- quantum-universe-os

**Status:** `inactive dead` (safe, not causing issues)

---

## Verification Commands

```bash
# Failed units (expected: 0)
systemctl --failed --no-pager

# Running count (expected: 12)
systemctl list-units "quantum*.service" --state=running --no-legend | wc -l

# Bad states check (expected: only "not-found inactive dead")
systemctl list-units "quantum*.service" --all --no-pager | grep -E "activating|failed"

# Quantum_redis hostname (expected: 127.0.0.1)
getent hosts quantum_redis

# No stale references (expected: no output)
grep -RIn "quantum-ai-engine\.service" /etc/systemd/system
```

---

## System Info

**VPS:** 46.224.116.254  
**OS:** Ubuntu 24.04 Noble  
**Systemd:** v255  
**Python:** 3.12.3  
**Redis:** 127.0.0.1:6379 (system service)  
**User:** qt:qt (services run as qt)  
**Venvs:** /opt/quantum/venvs/ai-client-base (7.9GB shared)  
**Repo:** /home/qt/quantum_trader

---

## Next Steps (Optional)

1. **Cloud-init persistence** for /etc/hosts alias
2. **Code refactor** to use REDIS_HOST env var consistently
3. **Re-enable** quantum-clm and quantum-risk-safety with fixes
4. **Clean not-found units** from target (if visual clutter is issue)
5. **Add monitoring** for systemd state changes

---

**Author:** Principal Ops Engineer  
**Date:** 2026-01-07  
**Status:** Production Stable ✅
