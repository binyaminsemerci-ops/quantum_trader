"""Tests for Enhanced Logging Extensions."""

import pytest
from datetime import datetime, timezone, timedelta
from backend.services.logging_extensions import (
    enrich_trade_entry,
    enrich_trade_exit,
    format_trade_log_message,
)


class TestTradeEntryEnrichment:
    """Test trade entry enrichment."""
    
    def test_basic_entry_enrichment(self):
        """Test basic entry data enrichment."""
        entry = enrich_trade_entry(
            symbol="BTCUSDT",
            action="LONG",
            entry_price=50000.0,
            quantity=0.1,
            stop_loss=49000.0,
            take_profit=52500.0,
            atr=500.0,
            confidence=0.75,
            consensus="STRONG"
        )
        
        assert entry["symbol"] == "BTCUSDT"
        assert entry["action"] == "LONG"
        assert entry["entry_price"] == 50000.0
        assert entry["quantity"] == 0.1
        assert entry["notional"] == 5000.0
        assert entry["confidence"] == 0.75
        assert entry["consensus"] == "STRONG"
    
    def test_stop_loss_calculations(self):
        """Test stop loss distance calculations."""
        entry = enrich_trade_entry(
            symbol="ETHUSDT",
            action="LONG",
            entry_price=3000.0,
            quantity=1.0,
            stop_loss=2850.0,  # $150 = 5%
            take_profit=3450.0,
            atr=100.0,
            confidence=0.80,
            consensus="UNANIMOUS"
        )
        
        assert entry["sl_distance_dollars"] == 150.0
        assert entry["sl_distance_pct"] == pytest.approx(5.0, abs=0.01)
        assert entry["sl_distance_atr"] == 1.5  # 150 / 100
    
    def test_take_profit_calculations(self):
        """Test take profit distance calculations."""
        entry = enrich_trade_entry(
            symbol="SOLUSDT",
            action="SHORT",
            entry_price=100.0,
            quantity=10.0,
            stop_loss=105.0,
            take_profit=87.5,  # $12.5 = 12.5%
            atr=5.0,
            confidence=0.70,
            consensus="STRONG"
        )
        
        assert entry["tp_distance_dollars"] == 12.5
        assert entry["tp_distance_pct"] == 12.5
        assert entry["tp_distance_atr"] == 2.5  # 12.5 / 5
    
    def test_risk_reward_ratio(self):
        """Test risk/reward ratio calculation."""
        entry = enrich_trade_entry(
            symbol="BTCUSDT",
            action="LONG",
            entry_price=50000.0,
            quantity=0.1,
            stop_loss=49000.0,  # 1R = $1000
            take_profit=52500.0,  # 2.5R = $2500
            atr=500.0,
            confidence=0.75,
            consensus="STRONG"
        )
        
        assert entry["risk_reward_ratio"] == 2.5
    
    def test_with_regime(self):
        """Test entry enrichment with regime."""
        entry = enrich_trade_entry(
            symbol="BTCUSDT",
            action="LONG",
            entry_price=50000.0,
            quantity=0.1,
            stop_loss=49000.0,
            take_profit=52500.0,
            atr=500.0,
            confidence=0.75,
            consensus="STRONG",
            regime="NORMAL_VOL"
        )
        
        assert entry["regime_at_entry"] == "NORMAL_VOL"


class TestTradeExitEnrichment:
    """Test trade exit enrichment."""
    
    def test_winning_trade_exit(self):
        """Test exit enrichment for winning trade."""
        entry = enrich_trade_entry(
            symbol="BTCUSDT",
            action="LONG",
            entry_price=50000.0,
            quantity=0.1,
            stop_loss=49000.0,
            take_profit=52500.0,
            atr=500.0,
            confidence=0.75,
            consensus="STRONG",
            timestamp=datetime(2025, 1, 1, 10, 0, 0, tzinfo=timezone.utc)
        )
        
        exit_data = enrich_trade_exit(
            trade_entry=entry,
            exit_price=52500.0,
            exit_reason="TP_HIT",
            pnl_dollars=250.0,  # (52500 - 50000) * 0.1
            fees_estimate=3.0,
            slippage_estimate=2.0,
            timestamp=datetime(2025, 1, 1, 18, 0, 0, tzinfo=timezone.utc)
        )
        
        assert exit_data["exit_price"] == 52500.0
        assert exit_data["exit_reason"] == "TP_HIT"
        assert exit_data["pnl_dollars"] == 250.0
        assert exit_data["R_multiple"] == 2.5
        assert exit_data["total_costs"] == 5.0
        assert exit_data["net_pnl_dollars"] == 245.0
        assert exit_data["was_winner"] is True
        assert exit_data["duration_hours"] == 8.0
    
    def test_losing_trade_exit(self):
        """Test exit enrichment for losing trade."""
        entry = enrich_trade_entry(
            symbol="ETHUSDT",
            action="SHORT",
            entry_price=3000.0,
            quantity=1.0,
            stop_loss=3150.0,
            take_profit=2700.0,
            atr=100.0,
            confidence=0.70,
            consensus="STRONG",
            timestamp=datetime(2025, 1, 1, 10, 0, 0, tzinfo=timezone.utc)
        )
        
        exit_data = enrich_trade_exit(
            trade_entry=entry,
            exit_price=3150.0,
            exit_reason="SL_HIT",
            pnl_dollars=-150.0,
            fees_estimate=3.0,
            slippage_estimate=2.0,
            timestamp=datetime(2025, 1, 1, 12, 0, 0, tzinfo=timezone.utc)
        )
        
        assert exit_data["R_multiple"] == -1.0
        assert exit_data["net_pnl_dollars"] == -155.0
        assert exit_data["was_winner"] is False
        assert exit_data["duration_hours"] == 2.0
    
    def test_with_mfe_mae(self):
        """Test exit enrichment with MFE/MAE."""
        entry = enrich_trade_entry(
            symbol="SOLUSDT",
            action="LONG",
            entry_price=100.0,
            quantity=10.0,
            stop_loss=95.0,  # 1R = $5
            take_profit=115.0,
            atr=5.0,
            confidence=0.80,
            consensus="UNANIMOUS"
        )
        
        exit_data = enrich_trade_exit(
            trade_entry=entry,
            exit_price=110.0,
            exit_reason="TRAILING",
            pnl_dollars=100.0,
            fees_estimate=2.0,
            slippage_estimate=1.0,
            mfe=112.0,  # Best price reached
            mae=98.0    # Worst price reached
        )
        
        assert exit_data["mfe"] == 112.0
        assert exit_data["mfe_R"] == 2.4  # (112 - 100) / 5
        assert exit_data["mae"] == 98.0
        assert exit_data["mae_R"] == 0.4  # (100 - 98) / 5


class TestLogMessageFormatting:
    """Test log message formatting."""
    
    def test_entry_message(self):
        """Test entry log message formatting."""
        entry = enrich_trade_entry(
            symbol="BTCUSDT",
            action="LONG",
            entry_price=50000.0,
            quantity=0.1,
            stop_loss=49000.0,
            take_profit=52500.0,
            atr=500.0,
            confidence=0.75,
            consensus="STRONG",
            regime="NORMAL_VOL"
        )
        
        message = format_trade_log_message(entry, "ENTRY")
        
        assert "LONG BTCUSDT ENTRY" in message
        assert "50000" in message
        assert "STRONG" in message
        assert "NORMAL_VOL" in message
    
    def test_exit_message_winner(self):
        """Test exit log message for winner."""
        entry = enrich_trade_entry(
            symbol="ETHUSDT",
            action="SHORT",
            entry_price=3000.0,
            quantity=1.0,
            stop_loss=3150.0,
            take_profit=2700.0,
            atr=100.0,
            confidence=0.80,
            consensus="UNANIMOUS"
        )
        
        exit_data = enrich_trade_exit(
            trade_entry=entry,
            exit_price=2700.0,
            exit_reason="TP_HIT",
            pnl_dollars=300.0,
            fees_estimate=3.0,
            slippage_estimate=2.0
        )
        
        message = format_trade_log_message(exit_data, "EXIT")
        
        assert "✅" in message
        assert "SHORT ETHUSDT EXIT" in message
        assert "TP_HIT" in message
    
    def test_exit_message_loser(self):
        """Test exit log message for loser."""
        entry = enrich_trade_entry(
            symbol="SOLUSDT",
            action="LONG",
            entry_price=100.0,
            quantity=10.0,
            stop_loss=95.0,
            take_profit=115.0,
            atr=5.0,
            confidence=0.70,
            consensus="STRONG"
        )
        
        exit_data = enrich_trade_exit(
            trade_entry=entry,
            exit_price=95.0,
            exit_reason="SL_HIT",
            pnl_dollars=-50.0,
            fees_estimate=2.0,
            slippage_estimate=1.0
        )
        
        message = format_trade_log_message(exit_data, "EXIT")
        
        assert "❌" in message
        assert "SL_HIT" in message


if __name__ == "__main__":
    pytest.main([__file__, "-v"])
