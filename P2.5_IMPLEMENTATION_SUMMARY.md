# P2.5 Implementation Summary

**Date**: 2026-01-23  
**Phase**: P2.5 Harvest Proposal Publisher  
**Status**: ✅ Implementation complete, ready for VPS deployment  
**Commit**: 79b6b098

---

## What Was Implemented

P2.5 Harvest Proposal Publisher - a systemd service that:
1. Reads MarketState (P0.5) + Risk Proposals (P1.5) + Position snapshots from Redis
2. Computes harvest proposals using P2 Harvest Kernel (`compute_harvest_proposal`)
3. Publishes results to Redis: `quantum:harvest:proposal:<symbol>`

**Key principle**: Calc-only, NO trading actions, NO orders, NO execution.

---

## Files Created

### 1. Main Service (521 lines)
**Path**: `microservices/harvest_proposal_publisher/main.py`

**Key Components**:
- `PositionSourceAdapter`: Auto-detect positions (hash → stream → synthetic)
- `HarvestProposalPublisher`: Main service class
  - `get_market_state()`: Read from `quantum:marketstate:<symbol>`
  - `get_risk_proposal()`: Read from `quantum:risk:proposal:<symbol>` (or fallback)
  - `publish_proposal()`: Write to `quantum:harvest:proposal:<symbol>`
  - `should_publish()`: Rate limiting (only if changed materially or max age)
  - `run_cycle()`: Single publish cycle
  - `run_loop()`: Continuous loop (10s interval)

**Inputs**:
- `quantum:marketstate:<SYMBOL>` (P0.5): sigma, ts, p_trend, p_mr, p_chop
- `quantum:risk:proposal:<SYMBOL>` (P1.5): stop_dist_pct, proposed_sl
- Position snapshots (auto-detect or synthetic)

**Outputs**:
- `quantum:harvest:proposal:<SYMBOL>` (hash):
  - harvest_action, new_sl_proposed, R_net, risk_unit, cost_est
  - kill_score, reason_codes, computed_at_utc
  - Market state (sigma, ts, regime probs)
  - Position data (side, age, prices, pnl)

**Rate Limiting**:
- Publish only if:
  - harvest_action changed
  - new_sl_proposed changed >0.1%
  - kill_score changed >0.1%
  - Time since last publish >60s

### 2. Systemd Service
**Path**: `deployment/systemd/quantum-harvest-proposal.service`

```ini
[Unit]
Description=Quantum Trader - Harvest Proposal Publisher (P2.5)
After=network.target redis.service quantum-marketstate.service quantum-risk-proposal.service
Wants=redis.service quantum-marketstate.service quantum-risk-proposal.service

[Service]
Type=simple
User=qt
WorkingDirectory=/home/qt/quantum_trader
Environment="PYTHONPATH=/home/qt/quantum_trader"
ExecStart=/opt/quantum/venvs/ai-engine/bin/python3 .../main.py
EnvironmentFile=/etc/quantum/harvest-proposal.env
Restart=always
RestartSec=10
```

### 3. Configuration File
**Path**: `deployment/config/harvest-proposal.env`

**Key settings**:
- `SYMBOLS=BTCUSDT,ETHUSDT,SOLUSDT`
- `PUBLISH_INTERVAL_SEC=10`
- `POSITION_SOURCE=auto` (try hash → stream → synthetic)
- `ENABLE_STREAM=false` (can enable for history)
- `FALLBACK_STOP_PCT=0.02` (if P1 proposal missing)
- `MAX_PUBLISH_AGE_SEC=60` (force publish after 60s)
- `CHANGE_EPS_PCT=0.001` (0.1% threshold)

### 4. Deployment Script
**Path**: `ops/deploy_harvest_proposal_publisher.sh`

**Actions**:
1. Check VPS environment (systemd exists)
2. Check dependencies (P0.5, P1.5 services)
3. Copy config to `/etc/quantum/harvest-proposal.env`
4. Copy service to `/etc/systemd/system/quantum-harvest-proposal.service`
5. Reload systemd
6. Enable and start service
7. Display verification commands

### 5. Documentation
**Path**: `docs/P2.5_HARVEST_PROPOSAL_PUBLISHER.md`

**Sections**:
- Overview and architecture
- Input/output Redis keys
- Rate limiting logic
- Configuration details
- Deployment instructions
- Testing procedures (local + VPS)
- 7-part proof pack checklist (P2.5B)
- Harvest Kernel logic summary
- Dependencies (P0.5, P1.5, P2)
- Troubleshooting guide

---

## Architecture Flow

```
┌─────────────────────────────────────────────────────────────┐
│                   P2.5 HARVEST PUBLISHER                     │
└─────────────────────────────────────────────────────────────┘
                            ▼
        ┌───────────────────────────────────────┐
        │        READ FROM REDIS                │
        ├───────────────────────────────────────┤
        │ 1. quantum:marketstate:BTCUSDT       │
        │    (sigma, ts, p_trend, p_mr, p_chop) │
        │ 2. quantum:risk:proposal:BTCUSDT     │
        │    (stop_dist_pct, proposed_sl)       │
        │ 3. Position snapshot (auto-detect)    │
        └───────────────────────────────────────┘
                            ▼
        ┌───────────────────────────────────────┐
        │      COMPUTE (P2 HARVEST KERNEL)      │
        ├───────────────────────────────────────┤
        │ risk_unit = entry * stop_dist_pct     │
        │ R_net = (pnl - cost) / risk_unit      │
        │                                        │
        │ Harvest action (R_net thresholds):    │
        │   R < 2.0 → NONE                      │
        │   R ≥ 2.0 → PARTIAL_25                │
        │   R ≥ 4.0 → PARTIAL_50                │
        │   R ≥ 6.0 → PARTIAL_75                │
        │                                        │
        │ Profit lock (R ≥ 1.5):                │
        │   new_sl = BE+ (monotonic tightening) │
        │                                        │
        │ Kill score (K sigmoid):                │
        │   regime_flip + sigma_spike +         │
        │   ts_drop + age_penalty               │
        │   K ≥ 0.6 → FULL_CLOSE_PROPOSED       │
        └───────────────────────────────────────┘
                            ▼
        ┌───────────────────────────────────────┐
        │       RATE LIMITING CHECK             │
        ├───────────────────────────────────────┤
        │ Skip publish if:                      │
        │   - harvest_action unchanged          │
        │   - new_sl_proposed Δ <0.1%           │
        │   - kill_score Δ <0.1%                │
        │   - age <60s                          │
        └───────────────────────────────────────┘
                            ▼
        ┌───────────────────────────────────────┐
        │        PUBLISH TO REDIS               │
        ├───────────────────────────────────────┤
        │ quantum:harvest:proposal:BTCUSDT      │
        │   harvest_action = PARTIAL_25         │
        │   new_sl_proposed = 100.2             │
        │   R_net = 2.45                        │
        │   kill_score = 0.503                  │
        │   reason_codes = harvest_T2,profit_lock│
        │   computed_at_utc = 2026-01-23T...    │
        │   (+ market state + position data)    │
        └───────────────────────────────────────┘
```

---

## Testing Strategy

### Local Testing (Synthetic Mode)
```bash
cd c:\quantum_trader

# Test with synthetic positions (no real data required)
python3 microservices/harvest_proposal_publisher/main.py \
    --once \
    --position-source synthetic \
    --symbols BTCUSDT

# Expected:
# - Generates synthetic LONG position (5% profit)
# - Computes R_net ~2.5 → PARTIAL_25
# - Publishes to Redis
```

### VPS Testing (Real Data)
```bash
# Prerequisites:
# - quantum-marketstate.service running
# - quantum-risk-proposal.service running
# - Redis with live data

# Test single cycle
cd /home/qt/quantum_trader
source /opt/quantum/venvs/ai-engine/bin/activate
python3 microservices/harvest_proposal_publisher/main.py --once

# Verify output
redis-cli HGETALL quantum:harvest:proposal:BTCUSDT
redis-cli HGET quantum:harvest:proposal:BTCUSDT harvest_action
redis-cli HGET quantum:harvest:proposal:BTCUSDT R_net
redis-cli HGET quantum:harvest:proposal:BTCUSDT kill_score
```

---

## Next Phase: P2.5B (VPS Deploy + Proof Pack)

### Manual Deployment Steps

1. **Copy files to VPS /tmp** (avoids git untracked files):
```bash
scp -i ~/.ssh/hetzner_fresh \
    microservices/harvest_proposal_publisher/main.py \
    deployment/systemd/quantum-harvest-proposal.service \
    deployment/config/harvest-proposal.env \
    ops/deploy_harvest_proposal_publisher.sh \
    root@46.224.116.254:/tmp/
```

2. **SSH to VPS and move files**:
```bash
ssh -i ~/.ssh/hetzner_fresh root@46.224.116.254
cd /home/qt/quantum_trader
mkdir -p microservices/harvest_proposal_publisher
cp /tmp/main.py microservices/harvest_proposal_publisher/
cp /tmp/quantum-harvest-proposal.service deployment/systemd/
cp /tmp/harvest-proposal.env deployment/config/
cp /tmp/deploy_harvest_proposal_publisher.sh ops/
chown -R qt:qt microservices/harvest_proposal_publisher ops/deploy_harvest_proposal_publisher.sh
```

3. **Run deployment script**:
```bash
bash ops/deploy_harvest_proposal_publisher.sh
```

### Proof Pack (7 Proofs)

**PROOF 1**: Calc-only import hygiene (AST analysis - only stdlib + redis + risk_kernel_harvest)  
**PROOF 2**: Systemd service active (`systemctl is-active quantum-harvest-proposal`)  
**PROOF 3**: P0.5 MarketState data exists (`redis-cli HGETALL quantum:marketstate:BTCUSDT`)  
**PROOF 4**: P1.5 risk proposals exist or fallback works  
**PROOF 5**: P2.5 harvest proposals published (all 3 symbols)  
**PROOF 6**: --once mode works (single cycle, exit 0)  
**PROOF 7**: Rate limiting (10s interval, 3 cycles in 30s)  

Create documentation: `P2.5B_VPS_PROOF_PACK_COMPLETE.md`

---

## Dependencies

### Upstream (Required)
- ✅ **P0**: MarketState Kernel (`ai_engine/market_state.py`) - LOCKED
- ✅ **P0.5**: MarketState Publisher (`quantum-marketstate.service`) - LOCKED
- ✅ **P1**: Risk Kernel (`ai_engine/risk_kernel_stops.py`) - LOCKED
- ✅ **P1.5**: Risk Proposal Publisher (`quantum-risk-proposal.service`) - LOCKED
- ✅ **P2**: Harvest Kernel (`ai_engine/risk_kernel_harvest.py`) - LOCKED

### Downstream (Future)
- **Dashboard**: Display harvest proposals (action, R_net, K)
- **P3+ Apply Layer**: Execute harvest proposals (MODIFY/CLOSE under safety gates)

---

## Key Differences from P1.5

| Aspect | P1.5 Risk Proposal | P2.5 Harvest Proposal |
|--------|-------------------|----------------------|
| **Input** | MarketState + Position | MarketState + Risk Proposal + Position |
| **Kernel** | `risk_kernel_stops` | `risk_kernel_harvest` |
| **Output Key** | `quantum:risk:proposal:<symbol>` | `quantum:harvest:proposal:<symbol>` |
| **Main Output** | proposed_sl, proposed_tp, stop_dist_pct | harvest_action, new_sl_proposed, R_net, kill_score |
| **Purpose** | Initial stops/trailing setup | Profit harvesting (partial exits, profit lock, kill signals) |
| **Fallback** | Default sigma/ts if missing | Fallback stop_dist_pct=0.02 if P1 missing |

---

## Implementation Stats

- **Lines of code**: 521 (main.py)
- **Imports**: 
  - stdlib: os, sys, time, json, logging, argparse, datetime, typing
  - external: redis
  - internal: ai_engine.risk_kernel_harvest
- **Functions**: 12 (across 2 classes)
- **Config options**: 13 environment variables
- **Testing modes**: 4 (auto, redis_hash, redis_stream, synthetic)
- **Rate limiting checks**: 4 conditions
- **Redis keys**: 3 types (marketstate, risk:proposal, harvest:proposal)
- **Systemd dependencies**: 3 services (marketstate, risk-proposal, redis)

---

## Validation Checklist

Before VPS deployment:

- [x] main.py created (521 lines)
- [x] systemd service file created
- [x] config env file created
- [x] deployment script created
- [x] documentation created (full guide)
- [x] Git commit (79b6b098)
- [x] No trading imports (calc-only verified)
- [x] PositionSourceAdapter (auto-detect logic)
- [x] Rate limiting logic (4 conditions)
- [x] Fallback behavior (missing P1 proposal)
- [x] Per-symbol isolation (errors don't cascade)
- [x] --once mode (single cycle for testing)
- [x] Logging (INFO level, structured messages)
- [ ] Local testing (--once --position-source synthetic)
- [ ] VPS deployment
- [ ] P2.5B proof pack (7 proofs)

---

## Success Criteria (P2.5B)

P2.5 is considered **LOCKED** after:

1. ✅ All 5 files committed (main.py, service, config, deploy script, docs)
2. ⏳ VPS deployment successful (service active)
3. ⏳ All 7 proofs pass:
   - Calc-only imports (AST verified)
   - Service active
   - MarketState data present
   - Risk proposals present (or fallback works)
   - Harvest proposals published
   - --once mode works
   - Rate limiting verified
4. ⏳ Proof pack report created and committed

**Current status**: 1/4 complete (implementation phase done)

---

## Commit Chain

```
79b6b098 (HEAD -> main) P2.5: Harvest Proposal Publisher (systemd, calc-only) ✅
2ca963a3 P2B: VPS deployment + proof pack COMPLETE ✅
7d4556d8 docs: P2 implementation summary and P1.5B proof pack report
82be192e P2: Harvest Kernel (calc-only) - profit harvesting proposals
bfedcf9a (origin/main) P1.5 Risk Proposal Publisher
86b561c2 P1 Risk Kernel: Stops/Trailing Proposal Engine
a6d74bbd Completion checklist: All Step 1B + Step 2 requirements verified
910a4706 Status report: P0 + P0.5 complete and operational
```

---

**Status**: ✅ P2.5 implementation complete  
**Next**: P2.5B VPS deployment + 7-proof pack  
**Timeline**: Ready for immediate deployment  
**Blockers**: None (all dependencies LOCKED)
